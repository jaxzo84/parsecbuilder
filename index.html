<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Five Parsecs from Home: Tactics - Army Builder</title>
    <style>
        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
            .print-page { page-break-after: always; }
        }
        .print-area { display: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e4e4e4; padding: 20px; min-height: 100vh; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 30px; background: linear-gradient(135deg, #c73e1d 0%, #a02c15 100%); border-radius: 12px; box-shadow: 0 8px 32px rgba(199, 62, 29, 0.3); }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .subtitle { font-size: 1.2em; opacity: 0.9; }
        .army-name-section { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .army-name-input { font-size: 1.5em; text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.15); border: 2px solid #c73e1d; border-radius: 8px; color: #fff; width: 100%; max-width: 600px; }
        .army-name-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .points-display { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .points-item { text-align: center; }
        .points-label { font-size: 0.9em; opacity: 0.7; margin-bottom: 5px; }
        .points-value { font-size: 2em; font-weight: bold; color: #c73e1d; }
        .validation-status { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; text-align: center; }
        .validation-status.valid { background: rgba(76, 175, 80, 0.3); border: 2px solid #4caf50; color: #4caf50; }
        .validation-status.invalid { background: rgba(244, 67, 54, 0.3); border: 2px solid #f44336; color: #f44336; }
        .validation-messages { margin-top: 10px; font-size: 0.9em; opacity: 0.9; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 8px; color: #e4e4e4; cursor: pointer; font-size: 1em; transition: all 0.3s; }
        .tab:hover { background: rgba(255, 255, 255, 0.2); }
        .tab.active { background: #c73e1d; box-shadow: 0 4px 12px rgba(199, 62, 29, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(199, 62, 29, 0.3); }
        .section-title { font-size: 1.5em; margin-bottom: 20px; color: #c73e1d; border-bottom: 2px solid #c73e1d; padding-bottom: 10px; }
        .unit-selector { background: #d0d0d0; color: #000; padding: 15px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; }
        .unit-selector:hover { border-color: #c73e1d; background: #e0e0e0; }
        .unit-selector.selected { border-color: #c73e1d; background: #f5f5f5; box-shadow: 0 0 0 3px rgba(199, 62, 29, 0.2); }
        .unit-selector-name { font-size: 1.2em; font-weight: bold; color: #c73e1d; margin-bottom: 8px; }
        .unit-selector-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin: 10px 0; }
        .unit-selector-stat { background: rgba(0, 0, 0, 0.1); padding: 5px 8px; border-radius: 4px; font-size: 0.9em; }
        .unit-selector-stat-label { font-weight: 600; color: #666; }
        .unit-selector-stat-value { color: #c73e1d; font-weight: bold; }
        .unit-selector-cost { font-size: 1.1em; font-weight: bold; color: #c73e1d; margin-top: 8px; }
        .unit-selector-notes { font-size: 0.85em; margin-top: 8px; color: #444; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #c73e1d; }
        input, select, textarea { width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(199, 62, 29, 0.3); border-radius: 6px; color: #e4e4e4; font-size: 1em; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #c73e1d; box-shadow: 0 0 0 3px rgba(199, 62, 29, 0.2); }
        button { padding: 12px 24px; background: #c73e1d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: all 0.3s; font-weight: 600; }
        button:hover { background: #a02c15; box-shadow: 0 4px 12px rgba(199, 62, 29, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: #000; font-weight: 600; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.5); }
        .btn-danger { background: #d32f2f; }
        .btn-danger:hover { background: #b71c1c; }
        .btn-small { padding: 6px 12px; font-size: 0.9em; }
        .army-list { display: flex; flex-direction: column; gap: 15px; }
        .army-unit { background: #d0d0d0; color: #000; padding: 20px; border-radius: 8px; border-left: 4px solid #c73e1d; }
        .army-unit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .army-unit-name { font-weight: bold; font-size: 1.3em; color: #c73e1d; }
        .army-unit-cost { font-size: 1.2em; font-weight: bold; background: #c73e1d; color: white; padding: 8px 16px; border-radius: 5px; }
        .army-unit-details { background: rgba(255, 255, 255, 0.5); padding: 15px; border-radius: 6px; margin: 10px 0; color: #000; }
        .army-unit-section { margin: 10px 0; }
        .army-unit-section-title { font-weight: bold; color: #c73e1d; margin-bottom: 5px; }
        .army-unit-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .option-group { background: rgba(255, 255, 255, 0.08); padding: 15px; border-radius: 8px; margin: 15px 0; }
        .option-title { font-weight: bold; color: #c73e1d; margin-bottom: 10px; font-size: 1.1em; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(199, 62, 29, 0.2); border-radius: 6px; }
        .option-title:hover { background: rgba(199, 62, 29, 0.3); }
        .option-title::after { content: '‚ñº'; font-size: 0.8em; transition: transform 0.3s; }
        .option-title.collapsed::after { transform: rotate(-90deg); }
        .option-content { max-height: 2000px; overflow: hidden; transition: max-height 0.3s ease-out; }
        .option-content.collapsed { max-height: 0; }
        .checkbox-option { background: #d0d0d0; color: #000; padding: 12px; margin: 8px 0; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center; }
        .checkbox-option:hover { border-color: #c73e1d; background: #e0e0e0; }
        .checkbox-option.selected { background: #f5f5f5; border-color: #c73e1d; }
        .checkbox-option-name { font-weight: 600; }
        .checkbox-option-cost { color: #c73e1d; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); overflow: auto; }
        .modal-content { background: #16213e; margin: 3% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 85vh; overflow-y: auto; border: 2px solid #c73e1d; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #c73e1d; }
        .notification { position: fixed; top: 20px; right: 20px; background: #c73e1d; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); display: none; z-index: 1001; }
        .notification.show { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .step-indicator { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .step-indicator-title { font-size: 1.2em; color: #c73e1d; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    <div class="container no-print">
        <header>
            <h1>üöÄ Five Parsecs from Home: Tactics</h1>
            <div class="subtitle">Comprehensive Army Builder</div>
        </header>
        <div class="army-name-section">
            <input type="text" id="armyName" class="army-name-input" placeholder="Enter your army name...">
        </div>
        <div id="validationStatus" class="validation-status"></div>
        <div class="points-display">
            <div class="points-item"><div class="points-label">Total Points</div><div class="points-value" id="totalPoints">0</div></div>
            <div class="points-item"><div class="points-label">Units</div><div class="points-value" id="unitCount">0</div></div>
            <div class="points-item"><div class="points-label">Point Limit</div><div class="points-value"><input type="number" id="pointLimit" value="500" onchange="validateArmy()" style="width: 100px; text-align: center; background: rgba(0,0,0,0.3); border: 1px solid #c73e1d; color: #c73e1d; font-size: 0.8em; padding: 5px;"></div></div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('army')">üìã My Army</button>
        </div>
        <div id="army" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Build Your Army</h2>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button onclick="startAddUnit('leader')">‚ûï Add Leader</button>
                    <button onclick="startAddUnit('infantry')">‚ûï Add Infantry</button>
                    <button onclick="startAddUnit('support')">‚ûï Add Support</button>
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Current Army List</h2>
                <div class="army-list" id="armyList">
                    <p style="opacity: 0.6; text-align: center; padding: 40px;">Your army is empty. Add units!</p>
                </div>
            </div>
            <div class="section">
                <h3 class="section-title">Export & Print</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="printStatCards()">üñ®Ô∏è Print Stat Cards</button>
                    <button onclick="exportAsText()">üìÑ Export as Text</button>
                    <button onclick="exportAsJSON()">üíæ Download JSON</button>
                    <button onclick="importJSON()" class="btn-secondary">üìÇ Import JSON</button>
                    <button onclick="clearArmy()" class="btn-danger">üóëÔ∏è Clear Army</button>
                </div>
            </div>
        </div>
    </div>
    <div class="print-area" id="printArea"></div>
    
    <div id="unitModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUnitModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const vehicleDatabase = {
            nominal_bike: { 
                name: 'Nominal Bike', 
                baseCost: 15, 
                speed: '12" Wheeled', 
                touchiness: 6, 
                kp: 2, 
                crew: 1, 
                capacity: 0, 
                baseWeapons: [], 
                weaponOptions: [
                    { id: 'lmg', name: 'Add forward-firing light machine gun', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Armored plating', cost: 5 },
                    { id: 'speed', name: 'Enhanced engine', cost: 5 }
                ],
                addonOptions: [
                    { id: 'storage', name: 'Storage compartment', cost: 2 },
                    { id: 'comms', name: 'Enhanced communications', cost: 3 }
                ],
                notes: 'Unarmed by default' 
            },
            scooter: { 
                name: 'Scooter', 
                baseCost: 35, 
                speed: '16" Drifter', 
                touchiness: 5, 
                kp: 2, 
                crew: 1, 
                capacity: 0, 
                baseWeapons: ['Forward-firing light machine gun'], 
                weaponOptions: [], 
                upgradeOptions: [
                    { id: 'armor', name: 'Light armor plating', cost: 5 }
                ],
                addonOptions: [
                    { id: 'scout', name: 'Scout equipment', cost: 3 }
                ],
                notes: '' 
            },
            lancer: { 
                name: 'Lancer', 
                baseCost: 30, 
                speed: '12" Drifter', 
                touchiness: 5, 
                kp: 2, 
                crew: 2, 
                capacity: 1, 
                baseWeapons: ['Forward gun mount', 'Plasma rifle'], 
                weaponOptions: [
                    { id: 'upgrade_plasma', name: 'Upgrade to heavy plasma rifle', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Armor plating', cost: 5 }
                ],
                addonOptions: [
                    { id: 'storage', name: 'Additional storage', cost: 2 }
                ],
                notes: '' 
            },
            raider_trike: { 
                name: 'Raider Trike', 
                baseCost: 35, 
                speed: '15" Wheeled', 
                touchiness: 5, 
                kp: 3, 
                crew: 2, 
                capacity: 0, 
                baseWeapons: ['Light machine gun'], 
                weaponOptions: [
                    { id: 'autocannon', name: 'Replace LMG with autocannon', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Reinforced frame', cost: 5 }
                ],
                addonOptions: [
                    { id: 'sidecar', name: 'Combat sidecar', cost: 5 }
                ],
                notes: '' 
            },
            frontier_trike: { 
                name: 'Frontier Trike', 
                baseCost: 35, 
                speed: '15" Wheeled', 
                touchiness: 6, 
                kp: 3, 
                crew: 2, 
                capacity: 0, 
                baseWeapons: ['Light machine gun'], 
                weaponOptions: [
                    { id: 'sidecar', name: 'Sidecar gun mount', cost: 5 },
                    { id: 'firepower', name: 'Firepower upgrade', cost: 7 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Armor plating', cost: 5 }
                ],
                addonOptions: [
                    { id: 'recon', name: 'Reconnaissance gear', cost: 3 }
                ],
                notes: '' 
            },
            fn_gray: { 
                name: 'FN-Gray', 
                baseCost: 75, 
                speed: '9" Drifter', 
                touchiness: 7, 
                kp: 4, 
                crew: 3, 
                capacity: 5, 
                baseWeapons: ['Front: Light machine gun', 'Turret: 20mm autocannon'], 
                weaponOptions: [
                    { id: 'heavy_plasma', name: 'Replace 20mm with heavy plasma gun (+upgrade cost)', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Heavy armor upgrade', cost: 10 },
                    { id: 'targeting', name: 'Targeting computer', cost: 8 }
                ],
                addonOptions: [
                    { id: 'transport', name: 'Troop transport upgrades', cost: 5 },
                    { id: 'medical', name: 'Medical bay', cost: 7 }
                ],
                notes: '' 
            },
            light_tank: { 
                name: 'Light Tank', 
                baseCost: 100, 
                speed: '8" Tracked', 
                touchiness: 8, 
                kp: 6, 
                crew: 4, 
                capacity: 0, 
                baseWeapons: ['Front: LMG', 'Coaxial: LMG', 'Turret: 40mm cannon'], 
                weaponOptions: [
                    { id: 'heavy_plasma', name: 'Replace 40mm with heavy plasma gun (+upgrade cost)', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'reactive_armor', name: 'Reactive armor', cost: 15 },
                    { id: 'stabilizers', name: 'Gun stabilizers', cost: 10 }
                ],
                addonOptions: [
                    { id: 'smoke', name: 'Smoke launchers', cost: 5 },
                    { id: 'comms', name: 'Command communications', cost: 8 }
                ],
                notes: '' 
            },
            medium_tank: { 
                name: 'Medium Tank', 
                baseCost: 140, 
                speed: '7" Tracked', 
                touchiness: 9, 
                kp: 7, 
                crew: 4, 
                capacity: 0, 
                baseWeapons: ['Front: LMG', 'Coaxial: LMG', 'Turret: 100mm cannon'], 
                weaponOptions: [
                    { id: 'heavy_plasma', name: 'Replace 100mm with heavy plasma gun (no upgrade cost)', cost: 0 }, 
                    { id: 'tank_laser', name: 'Replace 100mm with tank laser (no upgrade cost)', cost: 0 }
                ], 
                upgradeOptions: [
                    { id: 'composite_armor', name: 'Composite armor', cost: 20 },
                    { id: 'advanced_targeting', name: 'Advanced targeting system', cost: 12 }
                ],
                addonOptions: [
                    { id: 'smoke', name: 'Smoke launchers', cost: 5 },
                    { id: 'mine_plow', name: 'Mine plow', cost: 8 },
                    { id: 'comms', name: 'Command communications', cost: 8 }
                ],
                notes: '' 
            },
            light_walker: { 
                name: 'Light Walker', 
                baseCost: 70, 
                speed: '5" Walker', 
                touchiness: 8, 
                kp: 4, 
                crew: 1, 
                capacity: 0, 
                baseWeapons: ['1 arm with LMG'], 
                weaponOptions: [
                    { id: 'heavy_plasma', name: 'Replace LMG with heavy plasma gun', cost: 10 }, 
                    { id: 'fusion', name: 'Replace LMG with fusion rifle', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'jump_jets', name: 'Jump jets', cost: 15 },
                    { id: 'shield', name: 'Energy shield', cost: 12 }
                ],
                addonOptions: [
                    { id: 'sensor', name: 'Advanced sensors', cost: 8 }
                ],
                notes: 'Walkers fire both weapons simultaneously' 
            },
            heavy_tank: { 
                name: 'Heavy Tank', 
                baseCost: 200, 
                speed: '6" Tracked', 
                touchiness: 10, 
                kp: 8, 
                crew: 5, 
                capacity: 0, 
                baseWeapons: ['LMG', 'LMG', 'Main gun'], 
                weaponOptions: [
                    { id: 'plasma_1', name: 'Replace first LMG with heavy plasma gun (+upgrade cost)', cost: 10 }, 
                    { id: 'plasma_2', name: 'Replace second LMG with heavy plasma gun (+upgrade cost)', cost: 10 }
                ], 
                upgradeOptions: [
                    { id: 'super_heavy_armor', name: 'Super-heavy armor', cost: 25 },
                    { id: 'fire_control', name: 'Advanced fire control', cost: 15 }
                ],
                addonOptions: [
                    { id: 'smoke', name: 'Smoke launchers', cost: 5 },
                    { id: 'dozer', name: 'Dozer blade', cost: 10 },
                    { id: 'comms', name: 'Command communications', cost: 8 }
                ],
                notes: '' 
            },
            heavy_walker: { 
                name: 'Heavy Walker', 
                baseCost: 100, 
                speed: '4" Walker', 
                touchiness: 8, 
                kp: 5, 
                crew: 1, 
                capacity: 0, 
                baseWeapons: ['Shoulder: Pulse laser', 'Arm: LMG'], 
                weaponOptions: [
                    { id: 'missile', name: 'Add missile pod', cost: 15 }
                ], 
                upgradeOptions: [
                    { id: 'heavy_armor', name: 'Heavy armor plating', cost: 15 },
                    { id: 'targeting', name: 'Targeting computer', cost: 10 }
                ],
                addonOptions: [
                    { id: 'jump_jets', name: 'Jump jets', cost: 15 },
                    { id: 'sensor', name: 'Advanced sensors', cost: 8 }
                ],
                notes: 'Walkers fire both weapons simultaneously' 
            },
            cimal: { 
                name: 'CIMA-L', 
                baseCost: 35, 
                speed: '6" Walker', 
                touchiness: 7, 
                kp: 9, 
                crew: 0, 
                capacity: 0, 
                baseWeapons: ['Hyper blaster'], 
                weaponOptions: [
                    { id: 'fury', name: 'Replace hyper blaster with fury rifle (no upgrade cost)', cost: 0 }
                ], 
                upgradeOptions: [
                    { id: 'ai_upgrade', name: 'Advanced AI core', cost: 10 }
                ],
                addonOptions: [
                    { id: 'recon', name: 'Reconnaissance suite', cost: 5 }
                ],
                notes: '' 
            },
            cimap: { 
                name: 'CIMA-RP', 
                baseCost: 45, 
                speed: '4" Walker', 
                touchiness: 8, 
                kp: 4, 
                crew: 0, 
                capacity: 0, 
                baseWeapons: ['20mm autocannon'], 
                weaponOptions: [
                    { id: 'grenade', name: 'Add grenade launcher', cost: 8 }
                ], 
                upgradeOptions: [
                    { id: 'ai_upgrade', name: 'Advanced AI core', cost: 10 },
                    { id: 'armor', name: 'Armor plating', cost: 8 }
                ],
                addonOptions: [
                    { id: 'ecm', name: 'ECM suite', cost: 7 }
                ],
                notes: 'Advanced Purpose Platform' 
            },
            armored_car: { 
                name: 'Armored Car', 
                baseCost: 60, 
                speed: '9" Wheeled', 
                touchiness: 7, 
                kp: 5, 
                crew: 2, 
                capacity: 8, 
                baseWeapons: [], 
                weaponOptions: [
                    { id: 'lmg_front', name: 'Front mount: Light machine gun', cost: 0 }, 
                    { id: 'lmg_turret', name: 'Turret mount: Light machine gun', cost: 0 }, 
                    { id: '20mm_turret', name: 'Turret mount: 20mm autocannon', cost: 20 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Additional armor', cost: 10 }
                ],
                addonOptions: [
                    { id: 'scout', name: 'Scout equipment', cost: 5 },
                    { id: 'comms', name: 'Communications gear', cost: 5 }
                ],
                notes: 'Armored reconnaissance vehicle' 
            },
            apc: { 
                name: 'APC', 
                baseCost: 50, 
                speed: '8" Tracked', 
                touchiness: 7, 
                kp: 5, 
                crew: 2, 
                capacity: 10, 
                baseWeapons: [], 
                weaponOptions: [
                    { id: 'lmg_front', name: 'Front mount: Light machine gun', cost: 0 }, 
                    { id: 'lmg_turret', name: 'Turret mount: Light machine gun', cost: 0 }, 
                    { id: '20mm_turret', name: 'Turret mount: 20mm autocannon (+upgrade cost)', cost: 20 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Applique armor', cost: 10 },
                    { id: 'amphibious', name: 'Amphibious capability', cost: 15 }
                ],
                addonOptions: [
                    { id: 'medical', name: 'Medical bay', cost: 8 },
                    { id: 'command', name: 'Command module', cost: 10 }
                ],
                notes: 'Standard troop transport' 
            },
            ifv: { 
                name: 'IFV', 
                baseCost: 70, 
                speed: '8" Tracked', 
                touchiness: 7, 
                kp: 5, 
                crew: 3, 
                capacity: 6, 
                baseWeapons: ['20mm autocannon'], 
                weaponOptions: [
                    { id: 'heavy_plasma', name: 'Replace 20mm with heavy plasma gun (no upgrade cost)', cost: 0 },
                    { id: 'atgm', name: 'Add ATGM launcher', cost: 15 }
                ], 
                upgradeOptions: [
                    { id: 'armor', name: 'Additional armor', cost: 12 },
                    { id: 'fire_control', name: 'Fire control system', cost: 10 }
                ],
                addonOptions: [
                    { id: 'smoke', name: 'Smoke launchers', cost: 5 },
                    { id: 'comms', name: 'Enhanced communications', cost: 8 }
                ],
                notes: 'Infantry Fighting Vehicle' 
            }
        };

        const veteranSkills = [
            { id: 'brave', name: 'Brave', cost: 10, desc: '+1 to all Morale tests' },
            { id: 'tank_hunters', name: 'Tank hunters', cost: 10, desc: 'Shoot with two weapons and add +1 KP vs tanks (only one squad may take)' },
            { id: 'keen_shots', name: 'Keen shots', cost: 10, desc: 'All figures add +1 KP to hit rifle shots per activation' },
            { id: 'dishards', name: 'Dishards', cost: 10, desc: 'When deploying, can auto-replace damaged figures except leader' },
            { id: 'fire_drill', name: 'Fire drill', cost: 10, desc: 'Squad doesn\'t move when activating: +1 to all hit rolls' },
            { id: 'brawlers', name: 'Brawlers', cost: 5, desc: 'In close assault: re-roll 1s on attack dice' },
            { id: 'fearless', name: 'Fearless', cost: 35, desc: 'Squad becomes fearless (see page 26)' },
            { id: 'bombers', name: 'Bombers', cost: 5, desc: 'More figures per activation may throw grenades (not just 2)' },
            { id: 'guerillas', name: 'Guerillas', cost: 10, desc: 'Squad may be deployed while battling' },
            { id: 'quick', name: 'Quick', cost: 10, desc: 'Squad moves +4" when Dashing (instead of +2")' }
        ];

        let army = [];
        let armyName = '';
        let currentUnit = null;
        let editMode = false;

        document.addEventListener('DOMContentLoaded', () => {
            updateArmyDisplay();
            validateArmy();
            document.getElementById('armyName').addEventListener('input', (e) => { armyName = e.target.value; });
        });

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            event.target.classList.add('active');
        }

        function startAddUnit(type) {
            currentUnit = { type: type, selectedWeapons: [], selectedUpgrades: [], veteranSkills: [] };
            editMode = false;
            
            if (type === 'vehicle') {
                showVehicleSelection();
            } else if (type === 'leader') {
                showLeaderTypeSelection();
            } else if (type === 'infantry') {
                showInfantryTypeSelection();
            } else if (type === 'support') {
                showSupportTypeSelection();
            }
        }

        function showVehicleSelection() {
            let html = '<div class="step-indicator"><div class="step-indicator-title">Step 1: Select Vehicle</div></div>';
            html += '<h2 class="section-title">Select a Vehicle</h2>';
            
            Object.keys(vehicleDatabase).forEach(key => {
                const v = vehicleDatabase[key];
                html += `
                    <div class="unit-selector" onclick="selectVehicle('${key}')">
                        <div class="unit-selector-name">${v.name}</div>
                        <div class="unit-selector-stats">
                            <div class="unit-selector-stat"><span class="unit-selector-stat-label">Speed:</span> <span class="unit-selector-stat-value">${v.speed}</span></div>
                            <div class="unit-selector-stat"><span class="unit-selector-stat-label">T:</span> <span class="unit-selector-stat-value">${v.touchiness}</span></div>
                            <div class="unit-selector-stat"><span class="unit-selector-stat-label">KP:</span> <span class="unit-selector-stat-value">${v.kp}</span></div>
                            <div class="unit-selector-stat"><span class="unit-selector-stat-label">Crew:</span> <span class="unit-selector-stat-value">${v.crew}</span></div>
                            <div class="unit-selector-stat"><span class="unit-selector-stat-label">Capacity:</span> <span class="unit-selector-stat-value">${v.capacity}</span></div>
                        </div>
                        <div class="unit-selector-cost">Cost: ${v.baseCost} points</div>
                        ${v.baseWeapons.length > 0 ? `<div class="unit-selector-notes"><strong>Weapons:</strong> ${v.baseWeapons.join(', ')}</div>` : ''}
                        ${v.notes ? `<div class="unit-selector-notes">${v.notes}</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('unitModal').style.display = 'block';
        }

        function selectVehicle(key) {
            const v = vehicleDatabase[key];
            currentUnit.vehicleKey = key;
            currentUnit.name = v.name;
            currentUnit.baseCost = v.baseCost;
            currentUnit.speed = v.speed;
            currentUnit.touchiness = v.touchiness;
            currentUnit.kp = v.kp;
            currentUnit.crew = v.crew;
            currentUnit.capacity = v.capacity;
            currentUnit.baseWeapons = [...v.baseWeapons];
            currentUnit.weaponOptions = v.weaponOptions;
            currentUnit.upgradeOptions = v.upgrades || [];
            currentUnit.notes = v.notes;
            
            showUnitConfiguration();
        }

        function showLeaderTypeSelection() {
            let html = `
                <div class="step-indicator"><div class="step-indicator-title">Step 1: Select Leader Type</div></div>
                <h2 class="section-title">Leader Type</h2>
                <p style="margin-bottom: 20px; opacity: 0.9;">Leaders represent different levels of characters (0-1 per platoon)</p>
            `;
            
            const leaderTypes = [
                { id: 'minor', name: 'Minor Character', cost: 10, desc: 'Basic leader' },
                { id: 'major', name: 'Major Character', cost: 20, desc: 'Experienced leader' },
                { id: 'epic', name: 'Epic-Level Character', cost: 30, desc: 'Legendary leader' }
            ];
            
            leaderTypes.forEach(lt => {
                html += `
                    <div class="unit-selector" onclick="selectLeaderType('${lt.id}', ${lt.cost}, '${lt.name}')">
                        <div class="unit-selector-name">${lt.name}</div>
                        <div class="unit-selector-cost">Cost: ${lt.cost} points</div>
                        <div class="unit-selector-notes">${lt.desc}</div>
                    </div>
                `;
            });
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('unitModal').style.display = 'block';
        }

        function selectLeaderType(id, cost, name) {
            currentUnit.subtype = 'leader';
            currentUnit.leaderType = id;
            currentUnit.name = name;
            currentUnit.baseCost = cost;
            
            // Add leader options
            currentUnit.weaponOptions = [
                { id: 'plasma_pistol', name: 'Plasma pistol', cost: 5 },
                { id: 'power_weapon', name: 'Power weapon', cost: 8 },
                { id: 'assault_rifle', name: 'Assault rifle', cost: 3 }
            ];
            
            currentUnit.upgradeOptions = [
                { id: 'tactical_genius', name: 'Tactical genius (+1 to command rolls)', cost: 10 },
                { id: 'inspiring', name: 'Inspiring presence (+1 Morale nearby)', cost: 8 },
                { id: 'combat_expert', name: 'Combat expert (+1 KP in melee)', cost: 7 }
            ];
            
            currentUnit.addonOptions = [
                { id: 'combat_armor', name: 'Combat armor', cost: 5 },
                { id: 'scanner', name: 'Advanced scanner', cost: 4 },
                { id: 'comms', name: 'Command communications', cost: 3 }
            ];
            
            showUnitConfiguration();
        }

        function showInfantryTypeSelection() {
            let html = `
                <div class="step-indicator"><div class="step-indicator-title">Step 1: Select Infantry Type</div></div>
                <h2 class="section-title">Infantry Type</h2>
                <p style="margin-bottom: 20px; opacity: 0.9;">Infantry squads (1+ per platoon) - 4 soldiers + 1 sergeant (minor character)</p>
            `;
            
            const infantryTypes = [
                { id: 'infantry', name: 'Infantry', cost: 27, desc: '4 soldiers + 1 sergeant. Standard combat unit, equipped to carry out an array of battlefield tasks.' },
                { id: 'recon', name: 'Recon', cost: 23, desc: '4 soldiers + 1 sergeant. Lightly equipped units that harass the enemy from the flanks. +1 to all Observation distances.' },
                { id: 'storm', name: 'Storm', cost: 28, desc: '4 soldiers + 1 sergeant. Specialist troops for boarding operations and street fighting.' }
            ];
            
            infantryTypes.forEach(it => {
                html += `
                    <div class="unit-selector" onclick="selectInfantryType('${it.id}', ${it.cost}, '${it.name}')">
                        <div class="unit-selector-name">${it.name}</div>
                        <div class="unit-selector-cost">Base Cost: ${it.cost} points</div>
                        <div class="unit-selector-notes">${it.desc}</div>
                    </div>
                `;
            });
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('unitModal').style.display = 'block';
        }

        function selectInfantryType(id, cost, name) {
            currentUnit.subtype = 'troops';
            currentUnit.infantryType = id;
            currentUnit.name = name;
            currentUnit.baseCost = cost;
            
            // Configure based on infantry type
            if (id === 'infantry') {
                // Infantry squad (4 soldiers + 1 sergeant)
                currentUnit.baseWeapons = ['Military rifles (squad)', '1 light machine gun', 'Frag grenades (squad)'];
                
                currentUnit.weaponOptions = [
                    { id: 'replace_lmg_hyper', name: 'Replace LMG with hyper blaster', cost: 4 },
                    { id: 'replace_lmg_fury', name: 'Replace LMG with fury rifle', cost: 5 },
                    { id: 'replace_lmg_grenade', name: 'Replace LMG with grenade launcher (frag & fog)', cost: 2 },
                    { id: 'replace_lmg_plasma', name: 'Replace LMG with plasma rifle', cost: -2 },
                    { id: 'sergeant_shotgun', name: 'Sergeant: Replace weapon with shotgun & service pistol', cost: 0 }
                ];
                
                currentUnit.upgradeOptions = [
                    { id: 'infantry_lasers', name: 'Replace all rifles with infantry lasers', cost: 4 },
                    { id: 'fog_grenades', name: 'Add fog grenades to entire squad', cost: 5 }
                ];
                
                currentUnit.addonOptions = [
                    { id: 'mechanized', name: 'Mechanized Infantry (requires transport vehicle)', cost: 0 }
                ];
            } else if (id === 'recon') {
                // Recon squad (4 soldiers + 1 sergeant)
                currentUnit.baseWeapons = ['Military rifles (squad)', '1 precision rifle', '+1 to all Observation distances'];
                
                currentUnit.weaponOptions = [
                    { id: 'add_precision', name: 'Add precision rifle to one soldier', cost: 3 }
                ];
                
                currentUnit.upgradeOptions = [
                    { id: 'infantry_lasers', name: 'Replace all military rifles with infantry lasers', cost: 4 },
                    { id: 'service_pistols', name: 'Add service pistols to entire squad', cost: 5 }
                ];
                
                currentUnit.addonOptions = [
                    { id: 'mechanized', name: 'Mechanized Infantry (requires transport vehicle)', cost: 0 }
                ];
            } else if (id === 'storm') {
                // Storm squad (4 soldiers + 1 sergeant)
                currentUnit.baseWeapons = ['Shotguns & blades (squad)', '1 breaching axe', 'Frag & fog grenades (squad)'];
                
                currentUnit.weaponOptions = [
                    { id: 'sergeant_glare', name: 'Sergeant: Add glare sword', cost: 1 },
                    { id: 'sergeant_claw', name: 'Sergeant: Add powered claw', cost: 2 },
                    { id: 'soldier_flak_1', name: 'Soldier 1: Replace with flak gun', cost: 3 },
                    { id: 'soldier_flak_2', name: 'Soldier 2: Replace with flak gun', cost: 3 },
                    { id: 'soldier_flame_1', name: 'Soldier 1: Replace with flame projector', cost: 4 },
                    { id: 'soldier_flame_2', name: 'Soldier 2: Replace with flame projector', cost: 4 },
                    { id: 'soldier_fusion_1', name: 'Soldier 1: Replace with fusion rifle', cost: 8 },
                    { id: 'soldier_fusion_2', name: 'Soldier 2: Replace with fusion rifle', cost: 8 }
                ];
                
                currentUnit.upgradeOptions = [
                    { id: 'blasters', name: 'Replace all shotguns with blasters', cost: 5 },
                    { id: 'penetrator_grenades', name: 'Add penetrator grenades to entire squad', cost: 10 }
                ];
                
                currentUnit.addonOptions = [
                    { id: 'mechanized', name: 'Mechanized Infantry (requires transport vehicle)', cost: 0 }
                ];
            }
            
            showUnitConfiguration();
        }

        function showSupportTypeSelection() {
            let html = `
                <div class="step-indicator"><div class="step-indicator-title">Step 1: Select Support Type</div></div>
                <h2 class="section-title">Support Type</h2>
                <p style="margin-bottom: 20px; opacity: 0.9;">Support units (0-4 per platoon)</p>
                
                <h3 style="color: #c73e1d; margin: 20px 0 10px 0;">Weapon Teams</h3>
                <div class="unit-selector" onclick="selectSupportType('weapon_team')">
                    <div class="unit-selector-name">Weapon Team</div>
                    <div class="unit-selector-cost">Base Cost: 5 points</div>
                    <div class="unit-selector-notes">3 soldiers manning a Crewed weapon. +1 Morale bonus. Each carries service pistol.</div>
                </div>
                
                <h3 style="color: #c73e1d; margin: 20px 0 10px 0;">Specialists</h3>
                <div class="unit-selector" onclick="selectSupportType('tech')">
                    <div class="unit-selector-name">Tech</div>
                    <div class="unit-selector-cost">Base Cost: 5 points</div>
                    <div class="unit-selector-notes">1 soldier with service pistol. +1 dice bonus to hacking, repairs, construction, engineering.</div>
                </div>
                
                <div class="unit-selector" onclick="selectSupportType('sharpshooter')">
                    <div class="unit-selector-name">Sharpshooter</div>
                    <div class="unit-selector-cost">Base Cost: 15 points</div>
                    <div class="unit-selector-notes">1 soldier with sniper rifle & service pistol. +1 to all Shooting Hit rolls.</div>
                </div>
                
                <div class="unit-selector" onclick="selectSupportType('fire_section')">
                    <div class="unit-selector-name">Fire Section</div>
                    <div class="unit-selector-cost">Base Cost: 15 points</div>
                    <div class="unit-selector-notes">2-figure squad with service pistols. 1 plasma rifle. +1 Morale bonus.</div>
                </div>
                
                <div class="unit-selector" onclick="selectSupportType('comms')">
                    <div class="unit-selector-name">Comms</div>
                    <div class="unit-selector-cost">Base Cost: 10 points</div>
                    <div class="unit-selector-notes">1 soldier with service pistol. +1 to communications/jamming. +1 calling for support.</div>
                </div>
                
                <div class="unit-selector" onclick="selectSupportType('medic')">
                    <div class="unit-selector-name">Medic</div>
                    <div class="unit-selector-cost">Base Cost: 10 points</div>
                    <div class="unit-selector-notes">1 soldier with service pistol. Remove 1 Suppression from friendly unit within 6" per activation.</div>
                </div>
                
                <div class="unit-selector" onclick="selectSupportType('scout')">
                    <div class="unit-selector-name">Scout</div>
                    <div class="unit-selector-cost">Base Cost: 10 points</div>
                    <div class="unit-selector-notes">1 soldier with infantry laser. Speed +1". +2 to all Observation distances.</div>
                </div>
                
                <h3 style="color: #c73e1d; margin: 20px 0 10px 0;">Vehicles</h3>
                <div class="unit-selector" onclick="currentUnit.supportType='vehicle';showVehicleSelection();">
                    <div class="unit-selector-name">Support Vehicles</div>
                    <div class="unit-selector-notes">Add vehicles from the vehicle list as support units</div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('unitModal').style.display = 'block';
        }

        function selectSupportType(id) {
            currentUnit.subtype = 'support';
            currentUnit.supportType = id;
            
            if (id === 'weapon_team') {
                currentUnit.name = 'Weapon Team';
                currentUnit.baseCost = 5;
                currentUnit.baseWeapons = ['Service pistols (3 soldiers)', '+1 Morale bonus'];
                
                currentUnit.weaponOptions = [
                    { id: 'laser_cannon', name: 'Laser cannon (35 points)', cost: 35 },
                    { id: '20mm_autocannon', name: '20mm autocannon (20 points)', cost: 20 },
                    { id: 'infantry_mortar', name: 'Infantry mortar (15 points)', cost: 15 }
                ];
                
                currentUnit.upgradeOptions = [];
                currentUnit.addonOptions = [];
                
            } else if (id === 'tech') {
                currentUnit.name = 'Tech';
                currentUnit.baseCost = 5;
                currentUnit.baseWeapons = ['Service pistol', '+1 dice to hacking/repairs/construction/engineering'];
                
                currentUnit.weaponOptions = [
                    { id: 'hand_laser', name: 'Replace pistol with hand laser', cost: 1 }
                ];
                
                currentUnit.upgradeOptions = [];
                
                currentUnit.addonOptions = [
                    { id: 'jinx_grenades', name: 'Jinx grenades', cost: 3 },
                    { id: 'attachment', name: 'Can attach to any squad during deployment', cost: 0 }
                ];
                
            } else if (id === 'sharpshooter') {
                currentUnit.name = 'Sharpshooter';
                currentUnit.baseCost = 15;
                currentUnit.baseWeapons = ['Sniper rifle', 'Service pistol', '+1 to all Shooting Hit rolls'];
                
                currentUnit.weaponOptions = [];
                currentUnit.upgradeOptions = [];
                currentUnit.addonOptions = [];
                
            } else if (id === 'fire_section') {
                currentUnit.name = 'Fire Section';
                currentUnit.baseCost = 15;
                currentUnit.baseWeapons = ['Service pistols (2 soldiers)', '1 plasma rifle', '+1 Morale bonus'];
                
                currentUnit.weaponOptions = [
                    { id: 'replace_lmg', name: 'Replace plasma rifle with light machine gun', cost: 2 },
                    { id: 'replace_grenade', name: 'Replace plasma rifle with grenade launcher (frag, fog)', cost: 4 },
                    { id: 'replace_fury', name: 'Replace plasma rifle with fury rifle', cost: 7 },
                    { id: 'replace_hyper', name: 'Replace plasma rifle with hyper blaster', cost: 6 }
                ];
                
                currentUnit.upgradeOptions = [];
                
                currentUnit.addonOptions = [
                    { id: 'attachment', name: 'Can attach to any squad during deployment', cost: 0 }
                ];
                
            } else if (id === 'comms') {
                currentUnit.name = 'Comms';
                currentUnit.baseCost = 10;
                currentUnit.baseWeapons = ['Service pistol', '+1 to communications/jamming rolls', '+1 when calling for support'];
                
                currentUnit.weaponOptions = [];
                currentUnit.upgradeOptions = [];
                currentUnit.addonOptions = [];
                
            } else if (id === 'medic') {
                currentUnit.name = 'Medic';
                currentUnit.baseCost = 10;
                currentUnit.baseWeapons = ['Service pistol', 'Remove 1 Suppression from friendly within 6" per activation'];
                
                currentUnit.weaponOptions = [];
                currentUnit.upgradeOptions = [];
                currentUnit.addonOptions = [];
                
            } else if (id === 'scout') {
                currentUnit.name = 'Scout';
                currentUnit.baseCost = 10;
                currentUnit.baseWeapons = ['Infantry laser', 'Speed +1"', '+2 to all Observation distances'];
                
                currentUnit.weaponOptions = [];
                currentUnit.upgradeOptions = [];
                currentUnit.addonOptions = [];
            }
            
            showUnitConfiguration();
        }

        function showUnitConfiguration() {
            let html = `<div class="step-indicator"><div class="step-indicator-title">Step 2: Configure Unit</div></div>`;
            html += `<h2 class="section-title">${editMode ? 'Edit' : 'Configure'} ${currentUnit.name}</h2>`;
            
            // Show current stats
            if (currentUnit.type === 'vehicle') {
                html += `
                    <div class="option-group">
                        <div class="option-title" style="cursor: default;">Unit Stats</div>
                        <div class="option-content" style="background: #d0d0d0; color: #000; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                                <div><strong>Speed:</strong> ${currentUnit.speed}</div>
                                <div><strong>Touchiness:</strong> ${currentUnit.touchiness}</div>
                                <div><strong>KP:</strong> ${currentUnit.kp}</div>
                                <div><strong>Crew:</strong> ${currentUnit.crew}</div>
                                <div><strong>Capacity:</strong> ${currentUnit.capacity}</div>
                            </div>
                            ${currentUnit.baseWeapons.length > 0 ? `<div style="margin-top: 10px;"><strong>Base Weapons:</strong> ${currentUnit.baseWeapons.join(', ')}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Name input
            html += `
                <div class="form-group">
                    <label>Unit Name (Optional)</label>
                    <input type="text" id="unitCustomName" placeholder="e.g., Alpha Squad" value="${currentUnit.customName || ''}">
                </div>
            `;
            
            // Weapon options - Collapsible
            if (currentUnit.weaponOptions && currentUnit.weaponOptions.length > 0) {
                html += `
                    <div class="option-group">
                        <div class="option-title" onclick="toggleCollapse(this)">Weapon Options</div>
                        <div class="option-content">
                            ${currentUnit.weaponOptions.map((w, i) => `
                                <div class="checkbox-option ${currentUnit.selectedWeapons.includes(i) ? 'selected' : ''}" onclick="toggleSelection('weapon', ${i})">
                                    <span class="checkbox-option-name">${w.name}</span>
                                    <span class="checkbox-option-cost">${w.cost > 0 ? '+' : ''}${w.cost} pts</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Unit Upgrades - Collapsible (placeholder for now)
            if (currentUnit.upgradeOptions && currentUnit.upgradeOptions.length > 0) {
                html += `
                    <div class="option-group">
                        <div class="option-title" onclick="toggleCollapse(this)">Unit Upgrades</div>
                        <div class="option-content">
                            ${currentUnit.upgradeOptions.map((u, i) => `
                                <div class="checkbox-option ${(currentUnit.selectedUpgrades || []).includes(i) ? 'selected' : ''}" onclick="toggleSelection('upgrade', ${i})">
                                    <span class="checkbox-option-name">${u.name}</span>
                                    <span class="checkbox-option-cost">${u.cost > 0 ? '+' : ''}${u.cost} pts</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Unit Addons - Collapsible (placeholder for now)
            if (currentUnit.addonOptions && currentUnit.addonOptions.length > 0) {
                html += `
                    <div class="option-group">
                        <div class="option-title" onclick="toggleCollapse(this)">Unit Add-ons</div>
                        <div class="option-content">
                            ${currentUnit.addonOptions.map((a, i) => `
                                <div class="checkbox-option ${(currentUnit.selectedAddons || []).includes(i) ? 'selected' : ''}" onclick="toggleSelection('addon', ${i})">
                                    <span class="checkbox-option-name">${a.name}</span>
                                    <span class="checkbox-option-cost">${a.cost > 0 ? '+' : ''}${a.cost} pts</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Veteran upgrades - Collapsible
            html += `
                <div class="option-group">
                    <div class="option-title" onclick="toggleCollapse(this)">Veteran Skills (Optional)</div>
                    <div class="option-content">
                        <p style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">Each skill adds +1 to Morale tests (cumulative with Motivator)</p>
                        ${veteranSkills.map((s, i) => `
                            <div class="checkbox-option ${currentUnit.veteranSkills.includes(i) ? 'selected' : ''}" onclick="toggleSelection('veteran', ${i})">
                                <div>
                                    <div class="checkbox-option-name">${s.name}</div>
                                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 3px;">${s.desc}</div>
                                </div>
                                <span class="checkbox-option-cost">+${s.cost} pts</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Total cost
            const totalCost = calculateUnitCost();
            html += `
                <div style="margin-top: 20px; padding: 20px; background: rgba(199, 62, 29, 0.2); border-radius: 8px; text-align: center;">
                    <strong style="font-size: 1.3em;">Total Cost: ${totalCost} points</strong>
                </div>
                <button onclick="saveUnit()" style="margin-top: 15px; width: 100%;">${editMode ? 'Save Changes' : 'Add to Army'}</button>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('unitModal').style.display = 'block';
        }

        function toggleCollapse(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        function toggleSelection(type, index) {
            // Preserve custom name before refresh
            const nameInput = document.getElementById('unitCustomName');
            if (nameInput && nameInput.value) {
                currentUnit.customName = nameInput.value;
            }
            
            if (type === 'weapon') {
                const idx = currentUnit.selectedWeapons.indexOf(index);
                if (idx > -1) currentUnit.selectedWeapons.splice(idx, 1);
                else currentUnit.selectedWeapons.push(index);
            } else if (type === 'upgrade') {
                if (!currentUnit.selectedUpgrades) currentUnit.selectedUpgrades = [];
                const idx = currentUnit.selectedUpgrades.indexOf(index);
                if (idx > -1) currentUnit.selectedUpgrades.splice(idx, 1);
                else currentUnit.selectedUpgrades.push(index);
            } else if (type === 'addon') {
                if (!currentUnit.selectedAddons) currentUnit.selectedAddons = [];
                const idx = currentUnit.selectedAddons.indexOf(index);
                if (idx > -1) currentUnit.selectedAddons.splice(idx, 1);
                else currentUnit.selectedAddons.push(index);
            } else if (type === 'veteran') {
                const idx = currentUnit.veteranSkills.indexOf(index);
                if (idx > -1) currentUnit.veteranSkills.splice(idx, 1);
                else currentUnit.veteranSkills.push(index);
            }
            showUnitConfiguration(); // Refresh to update total
        }

        function calculateUnitCost() {
            let total = currentUnit.baseCost || 0;
            
            if (currentUnit.weaponOptions) {
                currentUnit.selectedWeapons.forEach(i => {
                    total += currentUnit.weaponOptions[i].cost;
                });
            }
            
            if (currentUnit.upgradeOptions && currentUnit.selectedUpgrades) {
                currentUnit.selectedUpgrades.forEach(i => {
                    total += currentUnit.upgradeOptions[i].cost;
                });
            }
            
            if (currentUnit.addonOptions && currentUnit.selectedAddons) {
                currentUnit.selectedAddons.forEach(i => {
                    total += currentUnit.addonOptions[i].cost;
                });
            }
            
            currentUnit.veteranSkills.forEach(i => {
                total += veteranSkills[i].cost;
            });
            
            return total;
        }

        function saveUnit() {
            const customName = document.getElementById('unitCustomName').value;
            if (customName) currentUnit.customName = customName;
            
            currentUnit.cost = calculateUnitCost();
            
            // Build weapons list
            currentUnit.weapons = [...(currentUnit.baseWeapons || [])];
            if (currentUnit.weaponOptions) {
                currentUnit.selectedWeapons.forEach(i => {
                    currentUnit.weapons.push(currentUnit.weaponOptions[i].name);
                });
            }
            
            // Build upgrades list
            currentUnit.upgrades = [];
            if (currentUnit.upgradeOptions && currentUnit.selectedUpgrades) {
                currentUnit.selectedUpgrades.forEach(i => {
                    currentUnit.upgrades.push(currentUnit.upgradeOptions[i].name);
                });
            }
            
            // Build addons list
            currentUnit.addons = [];
            if (currentUnit.addonOptions && currentUnit.selectedAddons) {
                currentUnit.selectedAddons.forEach(i => {
                    currentUnit.addons.push(currentUnit.addonOptions[i].name);
                });
            }
            
            // Build veteran skills list
            currentUnit.veteranSkillsList = currentUnit.veteranSkills.map(i => veteranSkills[i]);
            
            if (editMode) {
                // Update existing unit
                const index = army.findIndex(u => u.id === currentUnit.id);
                if (index > -1) army[index] = currentUnit;
            } else {
                // Add new unit
                currentUnit.id = Date.now();
                army.push(currentUnit);
            }
            
            updateArmyDisplay();
            validateArmy();
            closeUnitModal();
            showNotification(editMode ? 'Unit updated!' : 'Unit added to army!');
        }

        function editUnit(id) {
            currentUnit = JSON.parse(JSON.stringify(army.find(u => u.id === id)));
            editMode = true;
            showUnitConfiguration();
        }

        function removeUnit(id) {
            if (confirm('Remove this unit?')) {
                army = army.filter(u => u.id !== id);
                updateArmyDisplay();
                validateArmy();
                showNotification('Unit removed');
            }
        }

        function validateArmy() {
            const s = document.getElementById('validationStatus');
            const tp = army.reduce((sum, u) => sum + u.cost, 0);
            const pl = parseInt(document.getElementById('pointLimit').value) || 500;
            const l = army.filter(u => u.subtype === 'leader').length;
            const tr = army.filter(u => u.subtype === 'troops').length;
            const su = army.filter(u => u.subtype === 'support').length;
            const m = [];
            let v = true;
            
            if (tp > pl) { m.push(`‚ö†Ô∏è Exceeds limit (${tp}/${pl})`); v = false; }
            if (l > 1) { m.push(`‚ö†Ô∏è Too many Leaders (${l}/1)`); v = false; }
            if (tr < 1 && (l > 0 || su > 0)) { m.push(`‚ö†Ô∏è Need ‚â•1 Troops`); v = false; }
            if (su > 4) { m.push(`‚ö†Ô∏è Too many Support (${su}/4)`); v = false; }
            
            if (army.length === 0) { s.innerHTML = ''; return; }
            
            if (v) {
                s.className = 'validation-status valid';
                s.innerHTML = `‚úÖ Army is LEGAL<div class="validation-messages">${tp}/${pl} pts | Leaders: ${l}/1 | Troops: ${tr} | Support: ${su}/4</div>`;
            } else {
                s.className = 'validation-status invalid';
                s.innerHTML = `‚ùå Army is NOT LEGAL<div class="validation-messages">${m.join('<br>')}</div>`;
            }
        }

        function updateArmyDisplay() {
            const c = document.getElementById('armyList');
            const tp = army.reduce((sum, u) => sum + u.cost, 0);
            const uc = army.length;
            
            document.getElementById('totalPoints').textContent = tp;
            document.getElementById('unitCount').textContent = uc;
            
            if (army.length === 0) {
                c.innerHTML = '<p style="opacity: 0.6; text-align: center; padding: 40px;">Your army is empty. Add units!</p>';
                return;
            }
            
            c.innerHTML = army.map(u => {
                let d = '<div class="army-unit-details">';
                
                if (u.type === 'vehicle') {
                    d += `<div class="army-unit-section"><div class="army-unit-section-title">Stats</div>Speed: ${u.speed} | T: ${u.touchiness} | KP: ${u.kp} | Crew: ${u.crew} | Capacity: ${u.capacity}</div>`;
                    if (u.weapons && u.weapons.length > 0) {
                        d += `<div class="army-unit-section"><div class="army-unit-section-title">Weapons</div>${u.weapons.join('<br>')}</div>`;
                    }
                    if (u.upgrades && u.upgrades.length > 0) {
                        d += `<div class="army-unit-section"><div class="army-unit-section-title">Upgrades</div>${u.upgrades.join('<br>')}</div>`;
                    }
                    if (u.addons && u.addons.length > 0) {
                        d += `<div class="army-unit-section"><div class="army-unit-section-title">Add-ons</div>${u.addons.join('<br>')}</div>`;
                    }
                } else if (u.type === 'leader') {
                    d += `<div class="army-unit-section"><div class="army-unit-section-title">Type</div>Leader - ${u.leaderType}</div>`;
                } else if (u.type === 'infantry') {
                    d += `<div class="army-unit-section"><div class="army-unit-section-title">Type</div>Infantry - ${u.infantryType} (4 figures)</div>`;
                    if (u.weapons && u.weapons.length > 0) {
                        d += `<div class="army-unit-section"><div class="army-unit-section-title">Weapons</div>${u.weapons.join('<br>')}</div>`;
                    }
                    if (u.upgrades && u.upgrades.length > 0) {
                        d += `<div class="army-unit-section"><div class="army-unit-section-title">Upgrades</div>${u.upgrades.join('<br>')}</div>`;
                    }
                } else if (u.type === 'support') {
                    d += `<div class="army-unit-section"><div class="army-unit-section-title">Type</div>Support - ${u.supportType}</div>`;
                }
                
                if (u.veteranSkillsList && u.veteranSkillsList.length > 0) {
                    d += `<div class="army-unit-section"><div class="army-unit-section-title">Veteran Skills</div>${u.veteranSkillsList.map(s => `${s.name}: ${s.desc}`).join('<br>')}</div>`;
                }
                
                if (u.notes) {
                    d += `<div class="army-unit-section"><div class="army-unit-section-title">Notes</div>${u.notes}</div>`;
                }
                
                d += '</div>';
                
                return `
                    <div class="army-unit">
                        <div class="army-unit-header">
                            <div class="army-unit-name">${u.customName || u.name}</div>
                            <div class="army-unit-cost">${u.cost} pts</div>
                        </div>
                        ${d}
                        <div class="army-unit-actions">
                            <button onclick="editUnit(${u.id})" class="btn-secondary btn-small">Edit</button>
                            <button onclick="removeUnit(${u.id})" class="btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function printStatCards() {
            const p = document.getElementById('printArea');
            p.innerHTML = '';

            const style = document.createElement('style');
            style.textContent = `
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { background: white; }
                @media print {
                    body > *:not(#printArea) { display: none !important; }
                    #printArea { display: block !important; position: absolute; left:0; top:0; width:100%; }
                    .print-page { page-break-after: always; }
                }

                /* ===== PAGE GRID: 2 columns x 3 rows = 6 cards per A4 page ===== */
                #printArea { font-family: Arial, Helvetica, sans-serif; background: white; }
                .army-title-page {
                    display: flex; align-items: center; justify-content: center;
                    height: 30mm; font-size: 18pt; font-weight: bold;
                    border-bottom: 3px solid #c73e1d; margin-bottom: 4mm;
                    color: #c73e1d; letter-spacing: 2px;
                }
                .print-page {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    grid-template-rows: repeat(3, 1fr);
                    gap: 4mm;
                    padding: 8mm;
                    width: 210mm;
                    height: 297mm;
                    background: white;
                }

                /* ===== SHARED CARD BASE ===== */
                .card {
                    border: 2px solid #000;
                    border-radius: 6px;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    background: white;
                    font-size: 7pt;
                }

                /* ===== CARD HEADER ===== */
                .card-header {
                    display: flex;
                    align-items: stretch;
                    border-bottom: 2px solid #000;
                    min-height: 9mm;
                }
                .card-header-arrow {
                    padding: 2mm 2mm;
                    font-size: 10pt;
                    display: flex;
                    align-items: center;
                    border-right: 1px solid #000;
                    color: #000;
                }
                .card-header-label {
                    background: #c73e1d;
                    color: white;
                    font-size: 6pt;
                    font-weight: bold;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    writing-mode: vertical-rl;
                    transform: rotate(180deg);
                    padding: 2mm 1.5mm;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-right: 2px solid #000;
                    white-space: nowrap;
                }
                .card-header-name {
                    flex: 1;
                    font-size: 10pt;
                    font-weight: bold;
                    padding: 2mm 3mm;
                    display: flex;
                    align-items: center;
                    border-bottom: 2px solid #000;
                    color: #000;
                }
                .card-header-pts {
                    border-left: 2px solid #000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-width: 14mm;
                }
                .card-header-pts-label {
                    background: #000;
                    color: white;
                    font-size: 5pt;
                    font-weight: bold;
                    text-transform: uppercase;
                    text-align: center;
                    padding: 1mm;
                    width: 100%;
                    line-height: 1.2;
                }
                .card-header-pts-val {
                    font-size: 13pt;
                    font-weight: bold;
                    padding: 1mm;
                    color: #000;
                }

                /* ===== CARD BODY ===== */
                .card-body { display: flex; flex: 1; }

                /* ===== LEFT STAT COLUMN ===== */
                .card-stats {
                    display: flex;
                    flex-direction: column;
                    border-right: 2px solid #000;
                    min-width: 22mm;
                    max-width: 22mm;
                }
                .card-stat-row {
                    display: flex;
                    border-bottom: 1px solid #000;
                    flex: 1;
                }
                .card-stat-row:last-child { border-bottom: none; }
                .card-stat-label {
                    flex: 1;
                    padding: 1.5mm 2mm;
                    font-size: 6pt;
                    font-weight: bold;
                    border-right: 1px solid #000;
                    display: flex;
                    align-items: center;
                    color: #000;
                }
                .card-stat-val {
                    width: 8mm;
                    padding: 1.5mm 1mm;
                    font-size: 6pt;
                    text-align: center;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                }

                /* ===== RIGHT SIDE: weapons + veteran ===== */
                .card-right { flex: 1; display: flex; flex-direction: column; }

                /* Weapons table */
                .card-wep-table { flex: 1; display: flex; flex-direction: column; }
                .card-wep-header {
                    display: grid;
                    background: #c73e1d;
                    color: white;
                    font-size: 6pt;
                    font-weight: bold;
                    text-transform: uppercase;
                    text-align: center;
                    border-bottom: 1px solid #000;
                }
                .inf-wep-cols { grid-template-columns: 2.2fr 0.8fr 0.6fr 0.7fr 1.4fr; }
                .veh-wep-cols { grid-template-columns: 2.2fr 0.8fr 0.6fr 0.7fr 1.4fr; }
                .card-wep-header > div {
                    padding: 1.5mm 1mm;
                    border-right: 1px solid rgba(255,255,255,0.4);
                }
                .card-wep-header > div:last-child { border-right: none; }
                .card-wep-row {
                    display: grid;
                    border-bottom: 1px solid #ccc;
                    flex: 1;
                }
                .card-wep-row:last-child { border-bottom: none; }
                .card-wep-row > div {
                    padding: 1.2mm 1.5mm;
                    font-size: 6pt;
                    border-right: 1px solid #ddd;
                    display: flex;
                    align-items: center;
                    color: #000;
                }
                .card-wep-row > div:last-child { border-right: none; }
                .card-wep-row > div.centered { justify-content: center; }

                /* Veteran Skills */
                .card-vet {
                    border-top: 2px solid #000;
                }
                .card-vet-header {
                    background: #000;
                    color: white;
                    font-size: 6pt;
                    font-weight: bold;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    padding: 1.5mm 2mm;
                }
                .card-vet-body {
                    padding: 1.5mm 2mm;
                    font-size: 6pt;
                    min-height: 8mm;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1.5mm;
                    align-items: flex-start;
                    align-content: flex-start;
                    color: #000;
                }
                .card-vet-tag {
                    border: 1px solid #000;
                    border-radius: 2px;
                    padding: 0.5mm 2mm;
                    background: #f5f5f5;
                    font-size: 5.5pt;
                    color: #000;
                }

                /* Extras (upgrades/addons) */
                .card-extras {
                    border-top: 1px solid #aaa;
                    padding: 1mm 2mm;
                    font-size: 5.5pt;
                    color: #333;
                    line-height: 1.4;
                }
                .card-extras-lbl {
                    font-weight: bold;
                    text-transform: uppercase;
                    font-size: 5pt;
                    color: #c73e1d;
                    margin-bottom: 0.5mm;
                }
            `;
            p.appendChild(style);

            // Group units into pages of 6
            const pages = [];
            for (let i = 0; i < army.length; i += 6) {
                pages.push(army.slice(i, i + 6));
            }

            pages.forEach((pageUnits, pi) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'print-page';

                pageUnits.forEach(u => {
                    // Check if this is a vehicle (direct vehicle type OR support vehicle)
                    const isVehicle = u.type === 'vehicle' || (u.type === 'support' && u.supportType === 'vehicle');
                    const displayName = u.customName || u.name;
                    const typeLabel = isVehicle ? 'Vehicle' : u.type === 'leader' ? 'Leader' : u.type === 'support' ? 'Support' : 'Infantry';
                    const wepColClass = isVehicle ? 'veh-wep-cols' : 'inf-wep-cols';
                    const traitsHdr = isVehicle ? 'Traits/Arc' : 'Traits';

                    // Stats to show - use abbreviations for better fit
                    const stats = isVehicle
                        ? [['Speed', u.speed||'‚Äî'],['TOU', u.touchiness??'‚Äî'],['KP', u.kp??'‚Äî'],['Cap', u.capacity??'‚Äî']]
                        : [['Speed','6"'],['React','1'],['Combat','+0'],['TOU','3'],['KP','1'],['Savvy','+0'],['Train','Mil.']];

                    // Weapon rows
                    const weaponRows = buildWeaponRows(u);
                    const numRows = Math.max(isVehicle ? 3 : 4, weaponRows.length);

                    // Veteran skills
                    const vetSkills = u.veteranSkillsList || [];

                    // Extras
                    const allExtras = [
                        ...(u.upgrades||[]).map(x=>`‚Üë ${x}`),
                        ...(u.addons||[]).map(x=>`+ ${x}`)
                    ];

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-header-arrow">‚áê</div>
                            <div class="card-header-label">${typeLabel}</div>
                            <div style="flex:1; display:flex; flex-direction:column;">
                                <div class="card-header-name">${displayName}</div>
                            </div>
                            <div class="card-header-pts">
                                <div class="card-header-pts-label">Points<br>Cost</div>
                                <div class="card-header-pts-val">${u.cost}</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card-stats">
                                ${stats.map(([l,v])=>`<div class="card-stat-row"><div class="card-stat-label">${l}</div><div class="card-stat-val">${v}</div></div>`).join('')}
                            </div>
                            <div class="card-right">
                                <div class="card-wep-table">
                                    <div class="card-wep-header ${wepColClass}">
                                        <div>Weapons</div><div>Range</div><div>Shots</div><div>Dmg</div><div>${traitsHdr}</div>
                                    </div>
                                    ${Array.from({length: numRows}, (_,i) => {
                                        const w = weaponRows[i] || {name:'',range:'',shots:'',damage:'',traits:''};
                                        return `<div class="card-wep-row ${wepColClass}">
                                            <div>${w.name}</div>
                                            <div class="centered">${w.range}</div>
                                            <div class="centered">${w.shots}</div>
                                            <div class="centered">${w.damage}</div>
                                            <div>${w.traits}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                                <div class="card-vet">
                                    <div class="card-vet-header">Veteran Skills</div>
                                    <div class="card-vet-body">
                                        ${vetSkills.length > 0
                                            ? vetSkills.map(s=>`<span class="card-vet-tag"><b>${s.name}:</b> ${s.desc}</span>`).join('')
                                            : '<span style="color:#999;font-style:italic;">None</span>'}
                                    </div>
                                </div>
                                ${allExtras.length > 0 ? `
                                    <div class="card-extras">
                                        <div class="card-extras-lbl">Upgrades &amp; Add-ons</div>
                                        ${allExtras.join(' &nbsp; ')}
                                    </div>` : ''}
                            </div>
                        </div>
                    `;
                    pageDiv.appendChild(card);
                });

                p.appendChild(pageDiv);
            });

            window.print();
        }

        // Map weapons to stat rows for the weapons table
        function buildWeaponRows(u) {
            const wp = {
                'military rifles (squad)':          { range:'24"', shots:'1',  damage:'0', traits:'Auto' },
                'military rifles':                   { range:'24"', shots:'1',  damage:'0', traits:'Auto' },
                'infantry lasers':                   { range:'24"', shots:'1',  damage:'0', traits:'Auto, Laser' },
                '1 light machine gun':               { range:'24"', shots:'2',  damage:'0', traits:'Area' },
                'light machine gun':                 { range:'24"', shots:'2',  damage:'0', traits:'Area' },
                'front: lmg':                        { range:'24"', shots:'2',  damage:'0', traits:'Forward' },
                'coaxial: lmg':                      { range:'24"', shots:'2',  damage:'0', traits:'Coaxial' },
                'arm: lmg':                          { range:'24"', shots:'2',  damage:'0', traits:'' },
                'lmg':                               { range:'24"', shots:'2',  damage:'0', traits:'Area' },
                '1 arm with lmg':                    { range:'24"', shots:'2',  damage:'0', traits:'' },
                'forward-firing light machine gun':  { range:'24"', shots:'2',  damage:'0', traits:'Forward' },
                '1 precision rifle':                 { range:'30"', shots:'1',  damage:'1', traits:'Aim' },
                'precision rifle':                   { range:'30"', shots:'1',  damage:'1', traits:'Aim' },
                'shotguns & blades (squad)':         { range:'8"',  shots:'2',  damage:'0', traits:'Close, Blade' },
                'shotgun':                           { range:'8"',  shots:'2',  damage:'0', traits:'Close' },
                'blasters':                          { range:'16"', shots:'1',  damage:'1', traits:'' },
                'blaster':                           { range:'16"', shots:'1',  damage:'1', traits:'' },
                'service pistol':                    { range:'8"',  shots:'1',  damage:'0', traits:'' },
                'service pistols (3 soldiers)':      { range:'8"',  shots:'1',  damage:'0', traits:'' },
                'hand laser':                        { range:'10"', shots:'1',  damage:'0', traits:'Laser' },
                'infantry laser':                    { range:'24"', shots:'1',  damage:'0', traits:'Laser' },
                'sniper rifle':                      { range:'36"', shots:'1',  damage:'2', traits:'Aim, AP1' },
                'plasma rifle':                      { range:'24"', shots:'1',  damage:'2', traits:'AP2' },
                'heavy plasma gun':                  { range:'24"', shots:'1',  damage:'3', traits:'AP3' },
                'hyper blaster':                     { range:'16"', shots:'3',  damage:'0', traits:'Auto' },
                'fury rifle':                        { range:'24"', shots:'2',  damage:'1', traits:'' },
                'grenade launcher':                  { range:'18"', shots:'1',  damage:'1', traits:'Blast,Fog' },
                'flak gun':                          { range:'12"', shots:'2',  damage:'1', traits:'Blast' },
                'flame projector':                   { range:'8"',  shots:'*',  damage:'1', traits:'Flame' },
                'fusion rifle':                      { range:'12"', shots:'1',  damage:'4', traits:'AP4' },
                'power weapon':                      { range:'CC',  shots:'1',  damage:'2', traits:'AP2' },
                'glare sword':                       { range:'CC',  shots:'1',  damage:'1', traits:'Blind' },
                'powered claw':                      { range:'CC',  shots:'1',  damage:'2', traits:'AP2' },
                '1 breaching axe':                   { range:'CC',  shots:'1',  damage:'2', traits:'AP1' },
                'shoulder: pulse laser':             { range:'30"', shots:'2',  damage:'1', traits:'AP1' },
                'pulse laser':                       { range:'30"', shots:'2',  damage:'1', traits:'AP1' },
                '20mm autocannon':                   { range:'24"', shots:'2',  damage:'2', traits:'AP1' },
                'turret: 20mm autocannon':           { range:'24"', shots:'2',  damage:'2', traits:'Turret,AP1' },
                'front: light machine gun':          { range:'24"', shots:'2',  damage:'0', traits:'Forward' },
                'turret: 40mm cannon':               { range:'30"', shots:'1',  damage:'3', traits:'Turret,AP2' },
                '40mm cannon':                       { range:'30"', shots:'1',  damage:'3', traits:'AP2' },
                'turret: 100mm cannon':              { range:'36"', shots:'1',  damage:'5', traits:'Turret,AP4' },
                '100mm cannon':                      { range:'36"', shots:'1',  damage:'5', traits:'AP4' },
                'tank laser':                        { range:'48"', shots:'1',  damage:'4', traits:'Turret,AP3' },
                'laser cannon':                      { range:'48"', shots:'1',  damage:'4', traits:'AP3,Crew' },
                'laser cannon (35 points)':          { range:'48"', shots:'1',  damage:'4', traits:'AP3,Crew' },
                '20mm autocannon (20 points)':       { range:'24"', shots:'2',  damage:'2', traits:'AP1,Crew' },
                'infantry mortar (15 points)':       { range:'48"', shots:'1',  damage:'2', traits:'Blast,Crew' },
                'main gun':                          { range:'36"', shots:'1',  damage:'4', traits:'AP3' },
                'plasma rifle (forward)':            { range:'24"', shots:'1',  damage:'2', traits:'AP2,Fwd' },
                'forward gun mount':                 { range:'24"', shots:'2',  damage:'0', traits:'Forward' },
                'plasma rifle':                      { range:'24"', shots:'1',  damage:'2', traits:'AP2' },
            };

            const skipPatterns = ['+1 to', '+2 to', 'bonus', 'morale', 'suppression', 'observation',
                                   'speed +', 'frag', 'fog grenade', 'penetrator', 'mechanized',
                                   'breaching axe' /* handled separately */];

            const allWeapons = [];
            (u.baseWeapons || []).forEach(w => allWeapons.push(w));
            (u.weapons || []).forEach(w => {
                if (!(u.baseWeapons || []).includes(w)) allWeapons.push(w);
            });

            const rows = [];
            allWeapons.forEach(wName => {
                const lower = wName.toLowerCase();
                if (skipPatterns.some(p => lower.includes(p))) return;
                const stats = wp[lower] || { range:'‚Äî', shots:'‚Äî', damage:'‚Äî', traits:'‚Äî' };
                rows.push({ name: wName, ...stats });
            });
            return rows;
        }

        function exportAsText() {
            let t = '=== FIVE PARSECS FROM HOME: TACTICS ===\n\n';
            if (armyName) t += `Army: ${armyName}\n\n`;
            t += `Total: ${army.reduce((s, u) => s + u.cost, 0)} points\nUnits: ${army.length}\n\n`;
            army.forEach((u, i) => {
                t += `${i + 1}. ${u.customName || u.name} (${u.type}) - ${u.cost} pts\n`;
                if (u.weapons && u.weapons.length > 0) t += `   Weapons: ${u.weapons.join(', ')}\n`;
                if (u.veteranSkillsList && u.veteranSkillsList.length > 0) t += `   Veterans: ${u.veteranSkillsList.map(s => s.name).join(', ')}\n`;
                t += '\n';
            });
            const b = new Blob([t], { type: 'text/plain' });
            const url = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = url;
            a.download = (armyName || 'army') + '.txt';
            a.click();
            showNotification('Exported!');
        }

        function exportAsJSON() {
            const d = { game: 'Five Parsecs from Home: Tactics', armyName: armyName, totalPoints: army.reduce((s, u) => s + u.cost, 0), pointLimit: parseInt(document.getElementById('pointLimit').value), units: army };
            const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = url;
            a.download = (armyName || 'army') + '.json';
            a.click();
            showNotification('Exported!');
        }

        function importJSON() {
            const inp = document.createElement('input');
            inp.type = 'file';
            inp.accept = '.json';
            inp.onchange = (e) => {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if (d.armyName) { armyName = d.armyName; document.getElementById('armyName').value = armyName; }
                        if (d.pointLimit) document.getElementById('pointLimit').value = d.pointLimit;
                        if (d.units) { army = d.units; updateArmyDisplay(); validateArmy(); showNotification('Imported!'); }
                    } catch (err) { showNotification('Error: ' + err.message); }
                };
                r.readAsText(f);
            };
            inp.click();
        }

        function clearArmy() {
            if (confirm('Clear army?')) {
                army = [];
                updateArmyDisplay();
                validateArmy();
                showNotification('Cleared');
            }
        }

        function closeUnitModal() {
            document.getElementById('unitModal').style.display = 'none';
            currentUnit = null;
            editMode = false;
        }

        function showNotification(m) {
            const n = document.getElementById('notification');
            n.textContent = m;
            n.classList.add('show');
            setTimeout(() => { n.classList.remove('show'); }, 3000);
        }

        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>