<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactics Terminal - Printer Friendly</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --bg: #2b2b2b;          /* Neutral Dark Gray */
            --panel: #383838;       /* Slightly lighter panel */
            --border: #555;         /* Subtle border */
            --text: #e0e0e0;        /* Off-white text */
            --accent: #a0a0a0;      /* Silver accent */
            --highlight: #75b0eb;   /* Muted Blue for interaction */
            --success: #6cc771;
            --danger: #e06c75;
            --input-bg: #222;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 320px; background: #222; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .app-title { font-size: 1.4rem; color: #fff; letter-spacing: 1px; text-transform: uppercase; text-align: center; margin-bottom: 5px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        
        .control-group { margin-bottom: 20px; background: var(--panel); padding: 15px; border-radius: 4px; border: 1px solid var(--border); }
        .control-label { font-size: 0.75rem; text-transform: uppercase; color: #aaa; font-weight: bold; margin-bottom: 8px; display: block; }
        
        select, input[type="text"] { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 3px; margin-bottom: 10px; font-size: 0.9rem; box-sizing: border-box; }
        select:focus, input:focus { border-color: var(--highlight); outline: none; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 3px; font-weight: bold; cursor: pointer; margin-top: 5px; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn-primary { background: var(--highlight); color: #111; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-export { background: #fff; color: #000; margin-top: 10px; border: 1px solid #999; }
        
        .status-panel { margin-top: auto; border-top: 1px solid var(--border); padding-top: 15px; }
        .status-item { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #ccc; }
        .status-val { font-weight: bold; color: #fff; }
        .status-valid { color: var(--success); }
        .status-invalid { color: var(--danger); }

        /* MAIN AREA */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg); }
        
        .unit-card { 
            background: var(--panel); border: 1px solid var(--border); border-radius: 4px; 
            margin-bottom: 15px; position: relative;
        }
        
        .card-header { 
            padding: 10px 15px; background: #444; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); border-radius: 4px 4px 0 0;
        }
        
        /* Role Indicators (Subtle left border) */
        .role-Leader { border-left: 4px solid #d4bfff; }
        .role-Troops { border-left: 4px solid #ffeebb; }
        .role-Support { border-left: 4px solid #bfeeff; }
        .role-Specialist { border-left: 4px solid #ffbfbf; }

        .unit-role-badge { 
            font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-right: 10px; 
            background: #222; color: #aaa; border: 1px solid #555;
        }

        .card-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }

        /* STATS */
        .stats-row { display: flex; gap: 0; justify-content: center; background: #222; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; }
        .stat-box { 
            width: 50px; text-align: center; border-right: 1px solid var(--border); padding: 5px 0;
        }
        .stat-box:last-child { border: none; }
        .stat-label { font-size: 0.6rem; color: #888; display: block; font-weight: bold; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #fff; }

        /* CONFIG */
        .config-title { font-size: 0.75rem; color: #aaa; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
        .opt-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.9rem; }
        
        /* GEAR GRID */
        .gear-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 5px; }
        .gear-item { 
            background: #333; padding: 5px 8px; border-radius: 3px; font-size: 0.8rem; 
            display: flex; align-items: center; cursor: pointer; border: 1px solid transparent;
        }
        .gear-item:hover { border-color: #666; }
        .gear-item input { margin-right: 8px; margin-bottom:0; width:auto; }
        .gear-cost { color: #aaa; margin-left: auto; font-size: 0.75rem; }

        .del-btn { background: transparent; color: #888; border: none; font-size: 1.2rem; cursor: pointer; }
        .del-btn:hover { color: var(--danger); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="app-title">Tactics Terminal</div>

    <div class="control-group">
        <label class="control-label">Force Name</label>
        <input type="text" id="army-name" placeholder="e.g. 7th Colonial Guard">
    </div>

    <div class="control-group">
        <label class="control-label">Add Unit</label>
        <select id="sel-role" onchange="updateUnitTypes()">
            <option value="" disabled selected>1. Select Role...</option>
            <option value="Leader">Leader</option>
            <option value="Troops">Troops</option>
            <option value="Support">Support / Vehicle</option>
            <option value="Specialist">Specialist</option>
        </select>
        <select id="sel-type" disabled>
            <option>2. Select Type...</option>
        </select>
        <button class="btn btn-primary" onclick="addUnit()" id="btn-add" disabled>+ Add Unit</button>
    </div>

    <div class="status-panel">
        <div class="status-item"><span>Total Points:</span> <span id="total-pts" class="status-val" style="font-size:1.2rem;">0</span></div>
        <div class="status-item"><span>Leaders:</span> <span id="count-leader" class="status-val">0</span></div>
        <div class="status-item"><span>Troops:</span> <span id="count-troops" class="status-val">0</span></div>
        <div class="status-item"><span>Support:</span> <span id="count-support" class="status-val">0</span></div>
        <div class="status-item"><span>Specialists:</span> <span id="count-special" class="status-val">0</span></div>
        <div id="validation-output" style="margin-top:10px; font-size:0.8rem;"></div>
    </div>

    <button class="btn btn-export" onclick="generatePDF()">üñ®Ô∏è Print Data Cards (PDF)</button>
</div>

<div class="main-content" id="roster-area"></div>

<script>
    // --- DATA ---
    
    const INF_UPGRADES = {
        "Grenades": 2, "Frag Grenades": 3, "Fog Grenades": 5, "Screen Gen": 10,
        "Heavy Armor": 10, "Stealth Gear": 5, "Jet Packs": 5, "Bio-Chems": 5, "Blade": 2
    };

    const VEH_UPGRADES = {
        "Searchlight": 2, "Smoke Vents": 5, "Reinforced Hull": 10,
        "Targeter": 5, "Dozer Blade": 5, "Comms Array": 10
    };

    const WEAPONS = {
        "Handgun": { p: 1, type: "Pistol" }, "Blast Pistol": { p: 2, type: "Pistol" },
        "Military Rifle": { p: 3, type: "Rifle" }, "Infantry Laser": { p: 4, type: "Rifle" },
        "Shotgun": { p: 2, type: "Rifle" }, "Blaster": { p: 3, type: "Rifle" },
        "Sniper Rifle": { p: 10, type: "Heavy" }, "Plasma Rifle": { p: 8, type: "Heavy" },
        "Light MG": { p: 10, type: "Heavy" }, "Grenade Lnch": { p: 10, type: "Heavy" },
        "Fusion Rifle": { p: 8, type: "Heavy" }, "Flamer": { p: 8, type: "Heavy" },
        "Heavy MG": { p: 15, type: "Vehicle" }, "Autocannon": { p: 20, type: "Vehicle" },
        "Heavy Plasma": { p: 20, type: "Vehicle" }, "Laser Cannon": { p: 35, type: "Vehicle" },
        "Missiles": { p: 30, type: "Vehicle" }, "75mm Cannon": { p: 45, type: "Vehicle" }
    };

    const VET_SKILLS = {
        "None": 0, "Brave (+10)": 10, "Dead Eye (+10)": 10, "Brawlers (+5)": 5, 
        "Stealthy (+10)": 10, "Tough (+10)": 10, "Medic (+15)": 15, "Tank Hunters (+15)": 15
    };

    const ATTACHMENTS = {
        "None": 0, "Medic (+10)": 10, "Comms Bot (+8)": 8, "Servitor (+5)": 5, 
        "Combat Droid (+12)": 12, "Officer (+20)": 20
    };

    const UNIT_DEFS = {
        "Leader (Minor)": { role: "Leader", models: 1, base: 15, stats: {S:'5"',R:4,C:3,T:4,Sv:'4+',KP:1}, wpn: "Handgun" },
        "Leader (Major)": { role: "Leader", models: 1, base: 35, stats: {S:'6"',R:5,C:4,T:4,Sv:'4+',KP:2}, wpn: "Blast Pistol" },
        "Infantry Squad": { role: "Troops", models: 5, base: 15, stats: {S:'4"',R:3,C:4,T:4,Sv:'5+',KP:1}, wpn: "Military Rifle" },
        "Storm Squad": { role: "Troops", models: 5, base: 30, stats: {S:'4"',R:3,C:3,T:5,Sv:'4+',KP:1}, wpn: "Blaster" },
        "Recon Team": { role: "Troops", models: 3, base: 20, stats: {S:'6"',R:4,C:3,T:3,Sv:'6+',KP:1}, wpn: "Shotgun" },
        "Sniper Team": { role: "Specialist", models: 2, base: 25, stats: {S:'5"',R:4,C:2,T:3,Sv:'5+',KP:1}, wpn: "Sniper Rifle" },
        "Nomad Bike": { role: "Support", cat: "Vehicle", base: 15, stats: {S:'10"',R:2,C:3,T:5,Sv:'5+',KP:3}, hardpoints: ["Fixed"] },
        "Light Walker": { role: "Support", cat: "Vehicle", base: 60, stats: {S:'5"',R:3,C:3,T:6,Sv:'5+',KP:4}, hardpoints: ["Arm R", "Arm L"] },
        "APC": { role: "Support", cat: "Vehicle", base: 50, stats: {S:'8"',R:2,C:1,T:7,Sv:'-',KP:5}, hardpoints: ["Turret"] },
        "Battle Tank": { role: "Support", cat: "Vehicle", base: 140, stats: {S:'6"',R:2,C:3,T:9,Sv:'-',KP:6}, hardpoints: ["Main", "Hull"] }
    };

    let roster = [];

    // --- LOGIC ---

    function updateUnitTypes() {
        const role = document.getElementById('sel-role').value;
        const typeSel = document.getElementById('sel-type');
        typeSel.innerHTML = '<option value="" disabled selected>Select Unit...</option>';
        typeSel.disabled = false;
        document.getElementById('btn-add').disabled = true;

        Object.keys(UNIT_DEFS).forEach(key => {
            if (UNIT_DEFS[key].role === role) {
                typeSel.innerHTML += `<option value="${key}">${key}</option>`;
            }
        });
    }

    document.getElementById('sel-type').addEventListener('change', () => {
        document.getElementById('btn-add').disabled = false;
    });

    function addUnit() {
        const typeName = document.getElementById('sel-type').value;
        const def = UNIT_DEFS[typeName];
        
        const unit = {
            id: Date.now(),
            name: typeName,
            type: typeName,
            role: def.role,
            isVehicle: def.cat === "Vehicle",
            mainWeapon: def.wpn || "None",
            vehicleWeapons: {},
            activeUpgrades: [],
            veteran: "None",
            attachment: "None"
        };

        if (unit.isVehicle && def.hardpoints) {
            def.hardpoints.forEach(hp => unit.vehicleWeapons[hp] = "None");
        }

        roster.push(unit);
        renderRoster();
    }

    function removeUnit(id) {
        roster = roster.filter(u => u.id !== id);
        renderRoster();
    }

    function toggleUpgrade(id, upgradeName) {
        const unit = roster.find(u => u.id === id);
        const idx = unit.activeUpgrades.indexOf(upgradeName);
        if (idx > -1) unit.activeUpgrades.splice(idx, 1);
        else unit.activeUpgrades.push(upgradeName);
        renderRoster();
    }

    function calculateCost(unit) {
        const def = UNIT_DEFS[unit.type];
        let cost = def.base;

        if (!unit.isVehicle && def.wpn) {
            const baseP = WEAPONS[def.wpn] ? WEAPONS[def.wpn].p : 0;
            const newP = WEAPONS[unit.mainWeapon] ? WEAPONS[unit.mainWeapon].p : 0;
            cost += (newP - baseP) * def.models;
        }

        if (unit.isVehicle) {
            Object.values(unit.vehicleWeapons).forEach(w => {
                if(WEAPONS[w]) cost += WEAPONS[w].p;
            });
        }

        unit.activeUpgrades.forEach(upg => {
            if (unit.isVehicle) {
                if (VEH_UPGRADES[upg]) cost += VEH_UPGRADES[upg];
            } else {
                if (INF_UPGRADES[upg]) cost += (INF_UPGRADES[upg] * def.models);
            }
        });

        if (VET_SKILLS[unit.veteran]) cost += VET_SKILLS[unit.veteran];
        if (ATTACHMENTS[unit.attachment]) cost += ATTACHMENTS[unit.attachment];

        return cost;
    }

    function renderRoster() {
        const area = document.getElementById('roster-area');
        area.innerHTML = '';
        
        let armyTotal = 0;
        let counts = { Leader:0, Troops:0, Support:0, Specialist:0 };

        roster.forEach(unit => {
            const def = UNIT_DEFS[unit.type];
            const cost = calculateCost(unit);
            armyTotal += cost;
            counts[unit.role]++;

            const card = document.createElement('div');
            card.className = `unit-card role-${unit.role}`;
            
            const statsHTML = Object.keys(def.stats).map(k => `
                <div class="stat-box"><span class="stat-label">${k}</span><div class="stat-val">${def.stats[k]}</div></div>
            `).join('');

            const upgrades = unit.isVehicle ? VEH_UPGRADES : INF_UPGRADES;
            const upgradesHTML = Object.entries(upgrades).map(([name, pts]) => {
                const isChecked = unit.activeUpgrades.includes(name) ? 'checked' : '';
                return `
                <label class="gear-item">
                    <input type="checkbox" ${isChecked} onchange="toggleUpgrade(${unit.id}, '${name}')">
                    ${name} <span class="gear-cost">+${pts}</span>
                </label>`;
            }).join('');

            let weaponHTML = unit.isVehicle 
                ? Object.keys(unit.vehicleWeapons).map(slot => `
                    <div class="opt-row">
                        <span>${slot}</span>
                        <select onchange="updateUnitVal(${unit.id}, 'vehWpn', '${slot}', this.value)">
                            <option value="None">Empty</option>
                            ${Object.keys(WEAPONS).filter(k => WEAPONS[k].type === "Vehicle" || WEAPONS[k].type === "Heavy").map(w => 
                                `<option value="${w}" ${unit.vehicleWeapons[slot] === w ? 'selected' : ''}>${w} (${WEAPONS[w].p})</option>`
                            ).join('')}
                        </select>
                    </div>`).join('')
                : `
                <div class="opt-row">
                    <span>Main Weapon</span>
                    <select onchange="updateUnitVal(${unit.id}, 'mainWpn', null, this.value)">
                        ${Object.keys(WEAPONS).filter(k => WEAPONS[k].type === WEAPONS[def.wpn].type).map(w => 
                            `<option value="${w}" ${unit.mainWeapon === w ? 'selected' : ''}>${w}</option>`
                        ).join('')}
                    </select>
                </div>`;

            card.innerHTML = `
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        <span class="unit-role-badge">${unit.role}</span>
                        <input type="text" value="${unit.name}" 
                               style="width:200px; border:none; background:transparent; font-weight:bold; color:white; margin:0;"
                               onchange="updateUnitVal(${unit.id}, 'name', null, this.value)">
                    </div>
                    <div style="font-weight:bold; color:#fff;">${cost} pts</div>
                    <button class="del-btn" onclick="removeUnit(${unit.id})">√ó</button>
                </div>
                
                <div class="card-body">
                    <div class="full-width stats-row">${statsHTML}</div>
                    
                    <div>
                        <div class="config-title">Armament</div>
                        ${weaponHTML}
                    </div>

                    <div>
                        <div class="config-title">Training</div>
                        <div class="opt-row">
                            <span>Veteran Skill</span>
                            <select onchange="updateUnitVal(${unit.id}, 'vet', null, this.value)">
                                ${Object.keys(VET_SKILLS).map(s => `<option ${unit.veteran === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        ${!unit.isVehicle ? `
                        <div class="opt-row">
                            <span>Attachment</span>
                            <select onchange="updateUnitVal(${unit.id}, 'att', null, this.value)">
                                ${Object.keys(ATTACHMENTS).map(a => `<option ${unit.attachment === a ? 'selected' : ''}>${a}</option>`).join('')}
                            </select>
                        </div>` : ''}
                    </div>

                    <div class="full-width">
                        <div class="config-title">Upgrades</div>
                        <div class="gear-grid">${upgradesHTML}</div>
                    </div>
                </div>
            `;
            area.appendChild(card);
        });

        document.getElementById('total-pts').innerText = armyTotal;
        Object.keys(counts).forEach(k => document.getElementById(`count-${k.toLowerCase()}`).innerText = counts[k]);
        
        const validBox = document.getElementById('validation-output');
        let errs = [];
        if (counts.Leader < 1) errs.push("‚Ä¢ Need at least 1 Leader");
        if (counts.Troops < 2) errs.push("‚Ä¢ Need at least 2 Troops");
        if (counts.Support >= counts.Troops && counts.Troops > 0) errs.push("‚Ä¢ Support must be less than Troops");
        validBox.innerHTML = errs.length ? `<span class="status-invalid">${errs.join('<br>')}</span>` : `<span class="status-valid">‚úì Legal Force</span>`;
    }

    function updateUnitVal(id, field, key, val) {
        const unit = roster.find(u => u.id === id);
        if (!unit) return;
        if (field === 'vehWpn') unit.vehicleWeapons[key] = val;
        if (field === 'mainWpn') unit.mainWeapon = val;
        if (field === 'vet') unit.veteran = val;
        if (field === 'att') unit.attachment = val;
        if (field === 'name') unit.name = val;
        renderRoster();
    }

    // --- PDF GENERATION (PRINTER FRIENDLY) ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const armyName = document.getElementById('army-name').value || "TACTICAL FORCE";
        
        // White Background (Printer Friendly)
        doc.setFillColor(255, 255, 255); 
        doc.rect(0, 0, 210, 297, 'F');
        
        // Header
        doc.setTextColor(0, 0, 0); 
        doc.setFontSize(22); doc.setFont(undefined, 'bold');
        doc.text(armyName.toUpperCase(), 105, 20, null, null, 'center');
        
        doc.setFontSize(12); doc.setFont(undefined, 'normal');
        doc.text(`TOTAL POINTS: ${document.getElementById('total-pts').innerText}`, 105, 28, null, null, 'center');
        
        doc.setLineWidth(0.5);
        doc.line(20, 32, 190, 32);

        let y = 40;
        
        roster.forEach(unit => {
            // Check Page break
            if (y > 230) { 
                doc.addPage(); 
                doc.setFillColor(255, 255, 255); doc.rect(0, 0, 210, 297, 'F'); 
                y = 20; 
            }
            
            const def = UNIT_DEFS[unit.type];
            
            // CARD CONTAINER (Rounded Rect, Black Border)
            doc.setDrawColor(0); 
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 50, 1, 1, 'S');

            // HEADER STRIP (Light Gray for contrast)
            doc.setFillColor(230, 230, 230);
            doc.rect(20, y, 170, 8, 'F');
            doc.rect(20, y, 170, 8, 'S');

            // UNIT NAME & POINTS
            doc.setTextColor(0, 0, 0); doc.setFontSize(11); doc.setFont(undefined, 'bold');
            doc.text(`${unit.name.toUpperCase()} [${unit.role}]`, 25, y+5.5);
            doc.text(`${calculateCost(unit)} PTS`, 185, y+5.5, null, null, 'right');

            // STATS BOXES
            doc.setFontSize(8); doc.setFont(undefined, 'normal');
            let x = 25;
            
            Object.entries(def.stats).forEach(([k, v]) => {
                // Box
                doc.rect(x, y+12, 12, 12, 'S');
                // Label (Top)
                doc.setFontSize(6); 
                doc.text(k, x+6, y+15, null, null, 'center');
                // Value (Center)
                doc.setFontSize(10); doc.setFont(undefined, 'bold');
                doc.text(String(v), x+6, y+21, null, null, 'center');
                
                x += 14;
            });

            // INFO TEXT
            doc.setFontSize(9); doc.setFont(undefined, 'normal');
            
            // Weapons
            let wpnStr = unit.isVehicle 
                ? Object.values(unit.vehicleWeapons).filter(w=>w!=='None').join(', ')
                : `Main: ${unit.mainWeapon}`;
            
            // Gear / Skills
            let gearStr = unit.activeUpgrades.join(', ');
            let skillStr = [];
            if(unit.veteran !== "None") skillStr.push(`Vet: ${unit.veteran.split(' (+')[0]}`);
            if(unit.attachment !== "None") skillStr.push(`Att: ${unit.attachment.split(' (+')[0]}`);

            doc.text(`WEAPONS:`, 25, y+32);
            doc.setFont(undefined, 'bold');
            doc.text(wpnStr || "None", 45, y+32);
            doc.setFont(undefined, 'normal');

            doc.text(`GEAR:`, 25, y+38);
            doc.text(gearStr || "-", 45, y+38);

            if (skillStr.length > 0) {
                doc.text(`NOTES:`, 25, y+44);
                doc.text(skillStr.join(' | '), 45, y+44);
            }

            y += 56; // Spacing to next card
        });

        doc.save(`${armyName.replace(/\s/g,'_')}.pdf`);
    }
</script>
</body>
</html>