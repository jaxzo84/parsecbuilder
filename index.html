<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactics Terminal - Command Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --bg: #0f1216; --panel: #1c2128; --border: #30363d; 
            --text: #e6edf3; --accent: #ffb86c; --success: #3fb950; 
            --danger: #f85149; --highlight: #58a6ff;
            --input-bg: #0d1117;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- SIDEBAR (Construction & Status) --- */
        .sidebar { width: 320px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .app-title { font-size: 1.5rem; color: var(--text); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; text-align: center; }
        .app-subtitle { color: var(--accent); font-size: 0.8rem; text-align: center; margin-bottom: 25px; opacity: 0.8; }
        
        .control-group { margin-bottom: 25px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px; border: 1px solid var(--border); }
        .control-label { font-size: 0.75rem; text-transform: uppercase; color: #8b949e; font-weight: bold; margin-bottom: 8px; display: block; }
        
        select, input[type="text"] { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9rem; box-sizing: border-box; }
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; text-transform: uppercase; font-size: 0.85rem; transition: 0.2s; }
        .btn-primary { background: var(--success); color: #0d1117; }
        .btn-export { background: var(--highlight); color: #0d1117; margin-top: 10px; }
        .btn-reset { background: var(--danger); color: white; margin-top: 10px; }
        
        .status-panel { margin-top: auto; border-top: 1px solid var(--border); padding-top: 15px; }
        .status-item { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .status-val { font-weight: bold; }
        .status-valid { color: var(--success); }
        .status-invalid { color: var(--danger); }
        
        .validation-msg { font-size: 0.8rem; color: var(--danger); margin-top: 5px; line-height: 1.3; }

        /* --- MAIN AREA (Cards) --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        
        .unit-card { 
            background: #262c36; border: 1px solid var(--border); border-radius: 6px; 
            margin-bottom: 20px; overflow: hidden; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .card-header { 
            padding: 10px 15px; background: #30363d; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border);
        }
        .unit-role-badge { 
            font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-right: 10px; 
            text-transform: uppercase; font-weight: bold; color: #000;
        }
        /* Role Colors */
        .role-Leader { background: #bd93f9; border-left: 5px solid #bd93f9; }
        .role-Troops { background: #ffb86c; border-left: 5px solid #ffb86c; }
        .role-Support { background: #8be9fd; border-left: 5px solid #8be9fd; }
        .role-Specialist { background: #ff79c6; border-left: 5px solid #ff79c6; }

        .card-body { padding: 15px; }

        /* STATS BOXES (PDF Style) */
        .stats-row { display: flex; gap: 2px; margin-bottom: 15px; justify-content: center; }
        .stat-box { 
            background: #0d1117; border: 1px solid #444; width: 50px; text-align: center; 
            padding: 5px 0; border-radius: 2px;
        }
        .stat-label { font-size: 0.6rem; color: #8b949e; display: block; font-weight: bold; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #fff; }

        /* Config Sections */
        .config-section { margin-bottom: 15px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        .config-title { font-size: 0.75rem; color: #8b949e; text-transform: uppercase; font-weight: bold; margin-bottom: 8px; }
        
        .opt-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.9rem; }
        .opt-row select { width: 60%; margin: 0; }
        .cost-display { font-size: 0.85rem; color: var(--accent); font-weight: bold; width: 50px; text-align: right; }

        .del-btn { background: transparent; color: #8b949e; border: none; font-size: 1.2rem; cursor: pointer; }
        .del-btn:hover { color: var(--danger); }

    </style>
</head>
<body>

<div class="sidebar">
    <div style="text-align: center;">
        <h1 class="app-title">TACTICS TERMINAL</h1>
        <div class="app-subtitle">ARMY CONSTRUCTION SYSTEM</div>
    </div>

    <div class="control-group">
        <label class="control-label">Force Name</label>
        <input type="text" id="army-name" placeholder="e.g. 101st Void Marines" oninput="saveLocal()">
    </div>

    <div class="control-group">
        <label class="control-label">Add New Unit</label>
        
        <select id="sel-role" onchange="updateUnitTypes()">
            <option value="" disabled selected>1. Select Role...</option>
            <option value="Leader">Leader (Character)</option>
            <option value="Troops">Troops (Squad)</option>
            <option value="Support">Support (Vehicle/Team)</option>
            <option value="Specialist">Specialist (Elite)</option>
        </select>
        
        <select id="sel-type" disabled>
            <option>2. Select Unit Type...</option>
        </select>

        <button class="btn btn-primary" onclick="addUnit()" id="btn-add" disabled>+ Add to Roster</button>
    </div>

    <div class="status-panel">
        <label class="control-label">Platoon Status</label>
        <div class="status-item"><span>Points:</span> <span id="total-pts" class="status-val">0</span></div>
        <div class="status-item"><span>Leaders:</span> <span id="count-leader" class="status-val">0</span></div>
        <div class="status-item"><span>Troops:</span> <span id="count-troops" class="status-val">0</span></div>
        <div class="status-item"><span>Support:</span> <span id="count-support" class="status-val">0</span></div>
        <div class="status-item"><span>Specialists:</span> <span id="count-special" class="status-val">0</span></div>
        
        <div id="validation-output" class="validation-msg"></div>
    </div>

    <button class="btn btn-export" onclick="generatePDF()">üñ®Ô∏è Generate Data Cards</button>
</div>

<div class="main-content" id="roster-area">
    </div>

<script>
    // --- DATABASE ---
    
    const WEAPONS = {
        // Basic
        "Handgun": { p: 1, type: "Pistol" },
        "Blast Pistol": { p: 2, type: "Pistol" },
        "Hand Flamer": { p: 3, type: "Pistol" },
        "Military Rifle": { p: 3, type: "Rifle" },
        "Infantry Laser": { p: 4, type: "Rifle" },
        "Shotgun": { p: 2, type: "Rifle" },
        "Blaster": { p: 3, type: "Rifle" },
        "Needle Rifle": { p: 5, type: "Rifle" },
        // Heavy/Special
        "Sniper Rifle": { p: 10, type: "Heavy" },
        "Plasma Rifle": { p: 8, type: "Heavy" },
        "Light Machine Gun": { p: 10, type: "Heavy" },
        "Grenade Launcher": { p: 10, type: "Heavy" },
        "Fusion Rifle": { p: 8, type: "Heavy" },
        "Flamer": { p: 8, type: "Heavy" },
        // Vehicle/Support
        "Heavy Machine Gun": { p: 15, type: "Vehicle" },
        "20mm Autocannon": { p: 20, type: "Vehicle" },
        "Heavy Plasma": { p: 20, type: "Vehicle" },
        "Laser Cannon": { p: 35, type: "Vehicle" },
        "Missile Launcher": { p: 30, type: "Vehicle" },
        "75mm Cannon": { p: 45, type: "Vehicle" },
        "100mm Cannon": { p: 55, type: "Vehicle" },
        // Melee
        "Blade": { p: 0, type: "Melee" },
        "Power Claw": { p: 2, type: "Melee" },
        "Ripper Sword": { p: 1, type: "Melee" }
    };

    const VET_SKILLS = {
        "None": 0,
        "Brave (+10)": 10, "Dead Eye (+10)": 10, "Brawlers (+5)": 5, 
        "Stealthy (+10)": 10, "Tough (+10)": 10, "Medic (+15)": 15,
        "Tank Hunters (+15)": 15, "Gunnery (Veh) (+15)": 15, "Driver (Veh) (+10)": 10
    };

    const ATTACHMENTS = {
        "None": 0,
        "Medic (+10)": 10, "Comms Bot (+8)": 8, "Servitor (+5)": 5, 
        "Combat Droid (+12)": 12, "Officer (Lt) (+20)": 20
    };

    const UNIT_DEFS = {
        // --- LEADERS ---
        "Minor Character": { role: "Leader", models: 1, base: 15, hp: 1, stats: {S:'5"',R:4,C:3,T:4,Sv:'4+',KP:1}, wpn: "Handgun" },
        "Major Character": { role: "Leader", models: 1, base: 35, hp: 1, stats: {S:'6"',R:5,C:4,T:4,Sv:'4+',KP:2}, wpn: "Blast Pistol" },
        
        // --- TROOPS ---
        "Infantry Squad": { role: "Troops", models: 5, base: 15, hp: 0, stats: {S:'4"',R:3,C:4,T:4,Sv:'5+',KP:1}, wpn: "Military Rifle", heavySlots: 1 },
        "Recon Squad": { role: "Troops", models: 3, base: 20, hp: 0, stats: {S:'6"',R:4,C:3,T:3,Sv:'6+',KP:1}, wpn: "Shotgun", heavySlots: 1 },
        "Storm Squad": { role: "Troops", models: 5, base: 30, hp: 0, stats: {S:'4"',R:3,C:3,T:5,Sv:'4+',KP:1}, wpn: "Blaster", heavySlots: 2 },
        
        // --- SUPPORT (VEHICLES) ---
        "Nomad Bike": { role: "Support", category: "Vehicle", base: 15, hp: 1, stats: {S:'10"',R:2,C:3,T:5,Sv:'5+',KP:3, Cap:'-'}, hardpoints: ["Fixed Front"] },
        "Light Walker": { role: "Support", category: "Vehicle", base: 60, hp: 2, stats: {S:'5"',R:3,C:3,T:6,Sv:'5+',KP:4, Cap:'-'}, hardpoints: ["Right Arm", "Left Arm"] },
        "APC": { role: "Support", category: "Vehicle", base: 50, hp: 1, stats: {S:'8"',R:2,C:1,T:7,Sv:'-',KP:5, Cap:10}, hardpoints: ["Turret"] },
        "Light Tank": { role: "Support", category: "Vehicle", base: 85, hp: 2, stats: {S:'7"',R:2,C:2,T:8,Sv:'-',KP:5, Cap:'-'}, hardpoints: ["Turret", "Hull"] },
        "Medium Tank": { role: "Support", category: "Vehicle", base: 140, hp: 2, stats: {S:'6"',R:2,C:3,T:9,Sv:'-',KP:6, Cap:'-'}, hardpoints: ["Main Cannon", "Hull", "Sponson"] },
        
        // --- SPECIALISTS ---
        "Sniper Team": { role: "Specialist", models: 2, base: 25, hp: 0, stats: {S:'5"',R:4,C:2,T:3,Sv:'5+',KP:1}, wpn: "Sniper Rifle" },
        "Breach Team": { role: "Specialist", models: 3, base: 30, hp: 0, stats: {S:'5"',R:3,C:4,T:4,Sv:'4+',KP:1}, wpn: "Shotgun" }
    };

    let roster = [];

    // --- LOGIC ---

    function updateUnitTypes() {
        const role = document.getElementById('sel-role').value;
        const typeSel = document.getElementById('sel-type');
        typeSel.innerHTML = '<option value="" disabled selected>Select Unit...</option>';
        typeSel.disabled = false;
        document.getElementById('btn-add').disabled = true;

        Object.keys(UNIT_DEFS).forEach(key => {
            if (UNIT_DEFS[key].role === role) {
                typeSel.innerHTML += `<option value="${key}">${key}</option>`;
            }
        });
    }

    document.getElementById('sel-type').addEventListener('change', () => {
        document.getElementById('btn-add').disabled = false;
    });

    function addUnit() {
        const typeName = document.getElementById('sel-type').value;
        const def = UNIT_DEFS[typeName];
        
        const unit = {
            id: Date.now(),
            name: typeName, // Default name
            type: typeName,
            role: def.role,
            isVehicle: def.category === "Vehicle",
            
            // Configuration Defaults
            mainWeapon: def.wpn || "None",
            heavyWeapons: [],
            vehicleWeapons: {}, // for hardpoints
            veteran: "None",
            attachment: "None",
            notes: ""
        };

        // Initialize Vehicle Hardpoints
        if (unit.isVehicle && def.hardpoints) {
            def.hardpoints.forEach(hp => unit.vehicleWeapons[hp] = "None");
        }

        roster.push(unit);
        renderRoster();
    }

    function removeUnit(id) {
        roster = roster.filter(u => u.id !== id);
        renderRoster();
    }

    function calculateCost(unit) {
        const def = UNIT_DEFS[unit.type];
        let cost = def.base;

        // 1. Infantry Main Weapon Swap (Model multiplier)
        if (!unit.isVehicle && def.wpn) {
            const baseWpnPrice = WEAPONS[def.wpn] ? WEAPONS[def.wpn].p : 0;
            const newWpnPrice = WEAPONS[unit.mainWeapon] ? WEAPONS[unit.mainWeapon].p : 0;
            cost += (newWpnPrice - baseWpnPrice) * def.models;
        }

        // 2. Infantry Heavy Weapons (Add full cost, usually replaces rifle but usually counted as upgrade in tools)
        // Simplified: Add full cost of heavy weapon choice.
        unit.heavyWeapons.forEach(hw => {
            if(WEAPONS[hw]) cost += WEAPONS[hw].p;
        });

        // 3. Vehicle Weapons
        if (unit.isVehicle) {
            Object.values(unit.vehicleWeapons).forEach(w => {
                if(WEAPONS[w]) cost += WEAPONS[w].p;
            });
        }

        // 4. Attachments & Skills
        if (VET_SKILLS[unit.veteran]) cost += VET_SKILLS[unit.veteran];
        if (ATTACHMENTS[unit.attachment]) cost += ATTACHMENTS[unit.attachment];

        return cost;
    }

    function renderRoster() {
        const area = document.getElementById('roster-area');
        area.innerHTML = '';
        
        let armyTotal = 0;
        let counts = { Leader:0, Troops:0, Support:0, Specialist:0 };

        roster.forEach(unit => {
            const def = UNIT_DEFS[unit.type];
            const cost = calculateCost(unit);
            armyTotal += cost;
            counts[unit.role]++;

            const card = document.createElement('div');
            card.className = `unit-card role-${unit.role}`;
            
            // Build Hardpoint Selects for Vehicles
            let hardpointHTML = '';
            if (unit.isVehicle && def.hardpoints) {
                def.hardpoints.forEach(hp => {
                    hardpointHTML += `
                    <div class="opt-row">
                        <span class="config-title">${hp} Slot</span>
                        <select onchange="updateUnitVal(${unit.id}, 'vehWpn', '${hp}', this.value)">
                            <option value="None">Empty</option>
                            ${Object.keys(WEAPONS).filter(k => WEAPONS[k].type === "Vehicle" || WEAPONS[k].type === "Heavy").map(w => 
                                `<option value="${w}" ${unit.vehicleWeapons[hp] === w ? 'selected' : ''}>${w} (${WEAPONS[w].p}pts)</option>`
                            ).join('')}
                        </select>
                    </div>`;
                });
            }

            // Build Main Weapon Select for Infantry
            let mainWpnHTML = '';
            if (!unit.isVehicle && def.wpn) {
                const wpnType = WEAPONS[def.wpn].type;
                mainWpnHTML = `
                <div class="opt-row">
                    <span class="config-title">Squad Standard Issue</span>
                    <select onchange="updateUnitVal(${unit.id}, 'mainWpn', null, this.value)">
                        ${Object.keys(WEAPONS).filter(k => WEAPONS[k].type === wpnType).map(w => {
                            const diff = WEAPONS[w].p - WEAPONS[def.wpn].p;
                            return `<option value="${w}" ${unit.mainWeapon === w ? 'selected' : ''}>${w} (${diff > 0 ? '+'+diff : diff} pts/model)</option>`;
                        }).join('')}
                    </select>
                </div>`;
            }

            // Stats HTML
            const stats = def.stats;
            const statKeys = unit.isVehicle ? ['S','R','C','T','Sv','KP','Cap'] : ['S','R','C','T','Sv','KP'];
            const statsHTML = statKeys.map(k => `
                <div class="stat-box">
                    <span class="stat-label">${k}</span>
                    <div class="stat-val">${stats[k] || '-'}</div>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        <span class="unit-role-badge">${unit.role}</span>
                        <input type="text" value="${unit.name}" 
                               style="width:200px; border:none; background:transparent; font-weight:bold; color:white; margin:0;"
                               onchange="updateUnitVal(${unit.id}, 'name', null, this.value)">
                    </div>
                    <div style="font-weight:bold; color:var(--accent);">${cost} PTS</div>
                    <button class="del-btn" onclick="removeUnit(${unit.id})">√ó</button>
                </div>
                <div class="card-body">
                    <div class="stats-row">${statsHTML}</div>
                    
                    <div class="config-section">
                        ${mainWpnHTML}
                        ${hardpointHTML}
                    </div>

                    <div class="config-section">
                        <div class="opt-row">
                            <span class="config-title">Veteran Skill / Training</span>
                            <select onchange="updateUnitVal(${unit.id}, 'vet', null, this.value)">
                                ${Object.keys(VET_SKILLS).map(s => `<option ${unit.veteran === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        ${!unit.isVehicle ? `
                        <div class="opt-row">
                            <span class="config-title">Attachment (Specialist)</span>
                            <select onchange="updateUnitVal(${unit.id}, 'att', null, this.value)">
                                ${Object.keys(ATTACHMENTS).map(a => `<option ${unit.attachment === a ? 'selected' : ''}>${a}</option>`).join('')}
                            </select>
                        </div>` : ''}
                    </div>
                </div>
            `;
            area.appendChild(card);
        });

        // Update Stats Bar
        document.getElementById('total-pts').innerText = armyTotal;
        document.getElementById('count-leader').innerText = counts.Leader;
        document.getElementById('count-troops').innerText = counts.Troops;
        document.getElementById('count-support').innerText = counts.Support;
        document.getElementById('count-special').innerText = counts.Specialist;

        validatePlatoon(counts);
    }

    function updateUnitVal(id, field, key, val) {
        const unit = roster.find(u => u.id === id);
        if (!unit) return;

        if (field === 'vehWpn') unit.vehicleWeapons[key] = val;
        if (field === 'mainWpn') unit.mainWeapon = val;
        if (field === 'vet') unit.veteran = val;
        if (field === 'att') unit.attachment = val;
        if (field === 'name') unit.name = val;

        renderRoster();
    }

    function validatePlatoon(counts) {
        const out = document.getElementById('validation-output');
        let errors = [];

        if (counts.Leader < 1) errors.push("‚Ä¢ Must have at least 1 Leader.");
        if (counts.Troops < 2) errors.push("‚Ä¢ Must have at least 2 Troop squads.");
        if (counts.Support >= counts.Troops && counts.Troops > 0) errors.push("‚Ä¢ Support units must be fewer than Troop units.");
        if (counts.Specialist > Math.floor(counts.Troops / 2)) errors.push("‚Ä¢ Max 1 Specialist per 2 Troops.");

        if (errors.length > 0) {
            out.innerHTML = errors.join('<br>');
            out.className = "validation-msg status-invalid";
        } else {
            out.innerHTML = "‚úì Legal Platoon Structure";
            out.className = "validation-msg status-valid";
        }
    }

    // --- PDF GENERATION ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const armyName = document.getElementById('army-name').value || "TACTICAL DETACHMENT";
        
        // --- COVER ---
        doc.setFillColor(15, 18, 22); doc.rect(0, 0, 210, 297, 'F');
        doc.setTextColor(255, 184, 108); doc.setFontSize(22); doc.setFont(undefined, 'bold');
        doc.text(armyName.toUpperCase(), 105, 20, null, null, 'center');
        doc.setTextColor(255, 255, 255); doc.setFontSize(10);
        doc.text(`TOTAL POINTS: ${document.getElementById('total-pts').innerText}`, 105, 28, null, null, 'center');

        let y = 40;

        roster.forEach((unit, i) => {
            if (y > 240) { doc.addPage(); doc.setFillColor(15, 18, 22); doc.rect(0, 0, 210, 297, 'F'); y = 20; }
            
            const def = UNIT_DEFS[unit.type];
            const color = unit.role === 'Support' ? [139, 233, 253] : [255, 184, 108]; // Cyan for Veh, Orange for Inf
            
            // Card Container
            doc.setDrawColor(...color); doc.setLineWidth(0.8);
            doc.setFillColor(30, 35, 40);
            doc.roundedRect(15, y, 180, 50, 2, 2, 'FD');

            // Header
            doc.setFillColor(...color);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(0, 0, 0); doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text(`${unit.name.toUpperCase()} [${unit.role}]`, 20, y+6);
            doc.text(calculateCost(unit) + " PTS", 190, y+6, null, null, 'right');

            // STATS BOXES (The visual request)
            const stats = def.stats;
            const labels = unit.isVehicle ? ['S','R','C','T','Sv','KP','Cap'] : ['S','R','C','T','Sv','KP'];
            let xPos = 25;
            
            labels.forEach(k => {
                // Box
                doc.setDrawColor(80); doc.setFillColor(20);
                doc.rect(xPos, y+12, 14, 14, 'FD');
                // Label
                doc.setTextColor(...color); doc.setFontSize(7);
                doc.text(k, xPos+7, y+15, null, null, 'center');
                // Value
                doc.setTextColor(255); doc.setFontSize(11);
                doc.text(String(stats[k]||'-'), xPos+7, y+23, null, null, 'center');
                xPos += 18;
            });

            // LOADOUT TEXT
            doc.setFontSize(9); doc.setTextColor(200); doc.setFont(undefined, 'normal');
            let loadout = [];
            
            if (unit.isVehicle) {
                Object.entries(unit.vehicleWeapons).forEach(([slot, wpn]) => {
                    if(wpn !== "None") loadout.push(`${slot}: ${wpn}`);
                });
            } else {
                loadout.push(`Main: ${unit.mainWeapon}`);
            }
            
            if(unit.veteran !== "None") loadout.push(`Vet: ${unit.veteran.split(' (+')[0]}`);
            if(unit.attachment !== "None") loadout.push(`Att: ${unit.attachment.split(' (+')[0]}`);

            doc.text(loadout.join(' | '), 20, y+35);

            y += 58;
        });

        doc.save(`${armyName.replace(/\s/g,'_')}_Cards.pdf`);
    }

</script>
</body>
</html>