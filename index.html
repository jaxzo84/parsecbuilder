<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactics Terminal - Advanced Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --accent: #ffb86c; --border: #30363d; --ok: #50fa7b; --err: #ff5555; --char: #bd93f9; --veh: #8be9fd; --input-bg: #0d1117; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Layout & Typography */
        h2 { margin: 0; color: #fff; letter-spacing: 4px; text-transform: uppercase; }
        small { display: block; margin-top: 5px; color: var(--accent); opacity: 0.8; }
        .section-header { font-size: 0.75rem; text-transform: uppercase; color: #8b949e; border-bottom: 1px solid var(--border); margin-bottom: 8px; padding-bottom: 4px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }

        /* Unit Cards */
        .unit-card { background: #21262d; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid var(--accent); position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .role-Character { border-left-color: var(--char); }
        .role-Support { border-left-color: var(--veh); }

        /* Inputs & Grids */
        .top-row { display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 10px; margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; margin-bottom: 15px; border: 1px solid var(--border); }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.65rem; color: var(--accent); font-weight: bold; display: block; margin-bottom: 2px; }
        .stat-input { width: 100%; text-align: center; background: transparent; border: none; color: white; font-weight: bold; font-size: 1.1rem; }

        /* Config Areas */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .config-panel { background: rgba(255,255,255,0.02); padding: 10px; border-radius: 4px; border: 1px solid var(--border); }
        
        /* Form Elements */
        select, input[type="text"], textarea { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 0.9rem; box-sizing: border-box; }
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        
        /* Checkboxes & Lists */
        .opt-list { max-height: 150px; overflow-y: auto; }
        .opt-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 3px; cursor: pointer; }
        .opt-item:hover { background: rgba(255,255,255,0.05); }
        .opt-item input { margin-right: 8px; }
        .cost-badge { background: #30363d; padding: 1px 6px; border-radius: 3px; font-size: 0.75rem; color: var(--accent); }

        /* Buttons & Footer */
        .btn-row { display: flex; gap: 10px; margin-top: 25px; }
        .btn { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; transition: filter 0.2s; }
        .btn:hover { filter: brightness(1.2); }
        .btn-add { background: var(--accent); color: #161b22; flex: 1; }
        .btn-pdf { background: var(--ok); color: #161b22; flex: 1; }
        .btn-del { position: absolute; top: -10px; right: -10px; background: var(--err); color: white; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10; }

        .total-banner { text-align: right; margin-top: 20px; font-size: 2.5rem; font-weight: bold; color: var(--accent); border-top: 2px solid var(--border); padding-top: 10px; }
        .unit-pts-display { font-weight: bold; color: var(--ok); font-size: 1.1rem; text-align: center; display: flex; align-items: center; justify-content: center; background: rgba(80, 250, 123, 0.1); border-radius: 4px; border: 1px solid var(--ok); }

        /* Helper for attachments */
        .attachment-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .attachment-row select { flex: 1; }
        .attachment-row .qty { width: 50px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; padding-bottom:20px;">
        <h2>TACTICS TERMINAL</h2>
        <small>ADVANCED ARMY BUILDER FOR FIVE PARSECS: TACTICS</small>
    </div>

    <div id="unit-list"></div>
    
    <div class="btn-row">
        <button class="btn btn-add" onclick="createNewUnit()">+ Add Unit / Squad</button>
        <button class="btn btn-pdf" onclick="generatePDF()">üñ®Ô∏è Export PDF Cards</button>
    </div>

    <div class="total-banner">
        <span style="font-size:1rem; vertical-align:middle; color:#8b949e;">TOTAL ARMY VALUE:</span>
        <span id="army-total">0</span> PTS
    </div>
</div>

<script>
    // --- 1. DATABAS (REPO) ---
    // Baserat p√• PDF-regler.
    
    const WEAPONS = {
        "Military Rifle": { cost: 3, type: "Rifle" },
        "Infantry Laser": { cost: 4, type: "Rifle" },
        "Shotgun": { cost: 2, type: "Rifle" },
        "Blaster": { cost: 3, type: "Rifle" },
        "Needle Rifle": { cost: 5, type: "Rifle" },
        "Handgun": { cost: 1, type: "Pistol" },
        "Hand Flamer": { cost: 3, type: "Pistol" },
        "Dueling Pistol": { cost: 3, type: "Pistol" },
        "Power Claw": { cost: 2, type: "Melee" }
    };

    const ATTACHMENTS = {
        "None": { cost: 0 },
        "Medic": { cost: 10, note: "Ignore first casualty (5+)" },
        "Comms Bot": { cost: 8, note: "+1 Reaction" },
        "Servitor": { cost: 5, note: "Carry heavy gear" },
        "Combat Droid": { cost: 12, note: "Extra Combat die" },
        "Psychic (Minor)": { cost: 15, note: "Minor Psionics" },
        "Officer (Lt)": { cost: 20, note: "Order range 12\"" }
    };

    const UNIT_TYPES = {
        "Infantry Squad": {
            basePoints: 15, // Adjusted base (without weapons) assuming ~5 bodies at 3pts each base stats
            models: 5,
            defaultWeapon: "Military Rifle",
            role: "Troops",
            stats: { spd: '4"', rea: '3', cbt: '4', tou: '4', sav: '5+', kp: '1' },
            upgrades: {
                "Grenades (+2)": 2,
                "Fog Grenades (+5)": 5,
                "Blade Upgrade (+1/model)": 5, // 1 per model
                "Screen Generator (+10)": 10
            },
            heavyWeapons: ["Light Machine Gun (+10)", "Plasma Rifle (+8)", "Fury Rifle (+15)", "Grenade Launcher (+10)"]
        },
        "Storm Squad": {
            basePoints: 20,
            models: 5,
            defaultWeapon: "Blaster",
            role: "Troops",
            stats: { spd: '4"', rea: '3', cbt: '3', tou: '5', sav: '4+', kp: '1' },
            upgrades: {
                "Jet Packs (+5)": 5,
                "Heavy Armor (+10)": 10,
                "Penetrator Grenades (+10)": 10
            },
            heavyWeapons: ["Fusion Rifle (+8)", "Flame Projector (+4)", "Heavy Laser (+12)"]
        },
        "Specialist Team": {
            basePoints: 18,
            models: 3,
            defaultWeapon: "Shotgun",
            role: "Character", // Or Specialist
            stats: { spd: '5"', rea: '2', cbt: '3', tou: '3', sav: '6+', kp: '1' },
            upgrades: {
                "Stealth Gear (+5)": 5,
                "Demo Charges (+5)": 5
            },
            heavyWeapons: ["Sniper Rifle (+12)", "Flamer (+8)"]
        },
        "Light Walker": {
            basePoints: 60,
            models: 1,
            defaultWeapon: "None", // Vehicles often have fixed weapons or custom slots
            role: "Support",
            stats: { spd: '5"', rea: '3', cbt: '3', tou: '8', sav: '4+', kp: '4' },
            upgrades: {
                "Searchlight (+2)": 2,
                "Reinforced Hull (+10)": 10,
                "Smoke Launchers (+5)": 5
            },
            heavyWeapons: ["Heavy Plasma Swap (Free)", "Fusion Cannon Swap (+5)"]
        },
        "APC": {
            basePoints: 50,
            models: 1,
            defaultWeapon: "None",
            role: "Support",
            stats: { spd: '8"', rea: '2', cbt: '1', tou: '7', sav: '-', kp: '5' },
            upgrades: {
                "Guided Missiles (+15)": 15,
                "Dozer Blade (+5)": 5
            },
            heavyWeapons: ["Heavy Bolter (+10)"]
        }
    };

    // --- 2. LOGIK ---

    function createNewUnit() {
        const id = 'unit-' + Date.now();
        const container = document.getElementById('unit-list');
        const card = document.createElement('div');
        card.className = 'unit-card';
        card.id = id;
        
        // Initial HTML Structure
        card.innerHTML = `
            <button class="btn-del" onclick="removeUnit('${id}')">√ó</button>
            
            <div class="top-row">
                <input type="text" class="u-name" placeholder="Unit Designation (e.g. Alpha Squad)">
                
                <select class="u-type" onchange="loadUnitData('${id}')">
                    <option value="" disabled selected>Select Hull/Type...</option>
                    ${Object.keys(UNIT_TYPES).map(t => `<option value="${t}">${t}</option>`).join('')}
                </select>
                
                <select class="u-role">
                    <option>Troops</option><option>Support</option><option>Character</option>
                </select>

                <div class="unit-pts-display"><span class="u-points">0</span></div>
            </div>

            <div class="stats-grid">
                ${['SPD','REA','CBT','TOU','SAV','KP'].map(s => `
                    <div class="stat-box">
                        <span class="stat-label">${s}</span>
                        <input type="text" class="stat-input u-${s.toLowerCase()}" value="-">
                    </div>`).join('')}
            </div>

            <div class="config-grid">
                <div class="config-panel">
                    <div class="section-header">
                        <span>Loadout</span>
                        <small id="model-count-${id}">Models: 1</small>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label class="stat-label">Standard Weapon (Main Squad)</label>
                        <select class="u-std-weapon" onchange="calculatePoints('${id}')"></select>
                    </div>

                    <div style="margin-bottom:10px;">
                        <label class="stat-label">Heavy Weapons / Specialist Gear</label>
                        <div class="opt-list u-heavy-list"></div>
                    </div>
                </div>

                <div class="config-panel">
                    <div class="section-header">Upgrades & Attachments</div>
                    
                    <div class="opt-list u-upgrade-list" style="margin-bottom:10px; height:80px;"></div>
                    
                    <label class="stat-label">Unit Attachment (Add Model)</label>
                    <div class="attachment-row">
                        <select class="u-attachment" onchange="calculatePoints('${id}')">
                            ${Object.keys(ATTACHMENTS).map(a => `<option value="${a}">${a} (${ATTACHMENTS[a].cost}pts)</option>`).join('')}
                        </select>
                    </div>
                    
                    <textarea class="u-notes" placeholder="Notes, Traits or Veteran Skills..." style="height:40px; margin-top:5px;"></textarea>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    }

    function removeUnit(id) {
        document.getElementById(id).remove();
        updateTotal();
    }

    function loadUnitData(id) {
        const card = document.getElementById(id);
        const type = card.querySelector('.u-type').value;
        const data = UNIT_TYPES[type];

        if (!data) return;

        // Set Role
        card.querySelector('.u-role').value = data.role;
        card.className = `unit-card role-${data.role}`; // Update color
        
        // Set Stats
        Object.keys(data.stats).forEach(k => {
            card.querySelector(`.u-${k}`).value = data.stats[k];
        });

        // Set Model Count Display
        card.querySelector(`#model-count-${id}`).innerText = `Models: ${data.models}`;

        // Populate Standard Weapon Dropdown
        const weaponSel = card.querySelector('.u-std-weapon');
        weaponSel.innerHTML = '';
        
        if (data.defaultWeapon !== "None") {
            // Add Default First
            const defWep = WEAPONS[data.defaultWeapon];
            weaponSel.innerHTML += `<option value="${data.defaultWeapon}" data-cost="${defWep.cost}">${data.defaultWeapon} (Standard)</option>`;
            
            // Add Swaps (Compatible types only)
            const defType = defWep.type;
            Object.keys(WEAPONS).forEach(wName => {
                if (wName !== data.defaultWeapon && WEAPONS[wName].type === defType) {
                    const diff = WEAPONS[wName].cost - defWep.cost;
                    const sign = diff >= 0 ? '+' : '';
                    weaponSel.innerHTML += `<option value="${wName}" data-cost="${WEAPONS[wName].cost}">${wName} (${sign}${diff} pts)</option>`;
                }
            });
        } else {
            weaponSel.innerHTML = `<option value="None" data-cost="0">Vehicle / No Standard Weapon</option>`;
        }

        // Populate Upgrades
        const upgList = card.querySelector('.u-upgrade-list');
        upgList.innerHTML = '';
        Object.entries(data.upgrades).forEach(([name, cost]) => {
            upgList.innerHTML += `
                <label class="opt-item">
                    <span><input type="checkbox" class="chk-upgrade" value="${cost}" onchange="calculatePoints('${id}')"> ${name.split(' (')[0]}</span>
                    <span class="cost-badge">${cost} pts</span>
                </label>`;
        });

        // Populate Heavy Weapons
        const heavyList = card.querySelector('.u-heavy-list');
        heavyList.innerHTML = '';
        if (data.heavyWeapons) {
            data.heavyWeapons.forEach(hw => {
                // Parse "Name (+Cost)"
                const parts = hw.match(/(.+) \(([+-]?\d+|Free)\)/);
                const name = parts ? parts[1] : hw;
                const costStr = parts ? parts[2] : "0";
                const cost = costStr === "Free" ? 0 : parseInt(costStr);
                
                heavyList.innerHTML += `
                    <label class="opt-item">
                        <span><input type="checkbox" class="chk-heavy" value="${cost}" onchange="calculatePoints('${id}')"> ${name}</span>
                        <span class="cost-badge">${cost} pts</span>
                    </label>`;
            });
        }

        calculatePoints(id);
    }

    function calculatePoints(id) {
        const card = document.getElementById(id);
        const type = card.querySelector('.u-type').value;
        const data = UNIT_TYPES[type];
        if (!data) return;

        let total = data.basePoints;

        // 1. Standard Weapon Swap Logic
        // In 5PFH, you pay for weapons per model usually. 
        // If Base Points does NOT include weapons, we add full cost.
        // If Base Points INCLUDES default weapon, we add difference.
        // *Assumption*: Defined Base Points in this code excludes weapon cost to make math easier, 
        // OR we treat difference. Let's do Difference Method assuming Base Points implies "Ready to play with Rifles".
        
        const selectedWeaponOpt = card.querySelector('.u-std-weapon').selectedOptions[0];
        if (selectedWeaponOpt) {
            const currentWeaponCost = parseInt(selectedWeaponOpt.dataset.cost);
            const defaultWeaponCost = data.defaultWeapon !== "None" ? WEAPONS[data.defaultWeapon].cost : 0;
            const diff = currentWeaponCost - defaultWeaponCost;
            total += (diff * data.models);
        }

        // 2. Heavy Weapons (Usually replaces a rifle, so technically we should refund rifle? 
        // Or is the cost listed as an "Upgrade cost"? usually lists are "Upgrade for +X". 
        // We will assume the costs in lists are net upgrade costs).
        card.querySelectorAll('.chk-heavy:checked').forEach(chk => {
            total += parseInt(chk.value);
        });

        // 3. General Upgrades
        card.querySelectorAll('.chk-upgrade:checked').forEach(chk => {
            total += parseInt(chk.value);
        });

        // 4. Attachments
        const attachVal = card.querySelector('.u-attachment').value;
        if (ATTACHMENTS[attachVal]) {
            total += ATTACHMENTS[attachVal].cost;
        }

        // Display
        card.querySelector('.u-points').innerText = total + " PTS";
        card.dataset.points = total;
        
        updateTotal();
    }

    function updateTotal() {
        let sum = 0;
        document.querySelectorAll('.unit-card').forEach(c => {
            sum += parseInt(c.dataset.points || 0);
        });
        document.getElementById('army-total').innerText = sum;
    }

    // --- 3. PDF EXPORT ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let y = 20;
        
        doc.setFontSize(18);
        doc.text("ARMY ROSTER - TACTICS", 105, 15, null, null, "center");
        doc.setFontSize(10);
        doc.text(`Total Points: ${document.getElementById('army-total').innerText}`, 105, 22, null, null, "center");
        
        y = 30;

        document.querySelectorAll('.unit-card').forEach((card, index) => {
            if (y > 250) { doc.addPage(); y = 20; }

            const name = card.querySelector('.u-name').value || card.querySelector('.u-type').value;
            const type = card.querySelector('.u-type').value;
            const pts = card.querySelector('.u-points').innerText;
            const stats = Array.from(card.querySelectorAll('.stat-input')).map(i => i.value);
            
            // Card Box
            doc.setFillColor(240, 240, 240);
            doc.roundedRect(10, y, 190, 40, 3, 3, 'F');
            doc.setDrawColor(50);
            doc.roundedRect(10, y, 190, 40, 3, 3, 'S');

            // Header
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text(`${name} [${type}]`, 15, y+8);
            doc.text(pts, 185, y+8, null, null, "right");

            // Stats Line
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`SPD: ${stats[0]}  REA: ${stats[1]}  CBT: ${stats[2]}  TOU: ${stats[3]}  SAV: ${stats[4]}  KP: ${stats[5]}`, 15, y+15);

            // Loadout Text construction
            const stdWep = card.querySelector('.u-std-weapon').value;
            const heavies = Array.from(card.querySelectorAll('.chk-heavy:checked')).map(c => c.parentElement.innerText.split(' \n')[0]).join(', ');
            const upgs = Array.from(card.querySelectorAll('.chk-upgrade:checked')).map(c => c.parentElement.innerText.split(' \n')[0]).join(', ');
            const attach = card.querySelector('.u-attachment').value;
            const notes = card.querySelector('.u-notes').value;

            let loadoutStr = `Wpn: ${stdWep}`;
            if (heavies) loadoutStr += ` | Heavy: ${heavies}`;
            if (upgs) loadoutStr += ` | Gear: ${upgs}`;
            if (attach !== "None") loadoutStr += ` | Attached: ${attach}`;
            
            doc.setFontSize(8);
            doc.text(loadoutStr, 15, y+22, {maxWidth: 180});
            
            if (notes) {
                doc.setTextColor(100);
                doc.text(`Notes: ${notes}`, 15, y+35);
                doc.setTextColor(0);
            }

            y += 45;
        });

        doc.save('my_army_list.pdf');
    }
</script>

</body>
</html>