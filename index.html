<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactics Terminal - Command Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --bg: #222222; 
            --panel: #333333; 
            --border: #444444; 
            --text: #eeeeee; 
            --text-muted: #aaaaaa;
            --accent: #888888; 
            --highlight: #5b9dd9;   /* Neutral Blue for action */
            --valid: #66bb6a;
            --error: #ef5350;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 350px; background: #1a1a1a; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; overflow-y: auto; box-sizing: border-box; }
        .app-title { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: #fff; }

        .control-group { background: var(--panel); padding: 12px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 15px; }
        .control-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: bold; margin-bottom: 5px; display: block; }
        
        input, select { width: 100%; background: #222; border: 1px solid var(--border); color: #fff; padding: 6px; font-size: 0.9rem; box-sizing: border-box; margin-bottom: 8px; }
        input:focus, select:focus { border-color: var(--highlight); outline: none; }

        .btn { width: 100%; padding: 8px; border: none; border-radius: 3px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }
        .btn-primary { background: var(--highlight); color: #fff; }
        .btn-primary:hover { background: #4a8cc7; }
        .btn-print { background: #ddd; color: #000; margin-top: 10px; }

        .status-panel { margin-top: auto; border-top: 1px solid var(--border); padding-top: 10px; font-size: 0.85rem; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 3px; color: var(--text-muted); }
        .status-val { font-weight: bold; color: #fff; }
        .status-msg { margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; line-height: 1.4; font-size: 0.8rem; }
        .valid-text { color: var(--valid); }
        .error-text { color: var(--error); }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg); }
        
        .unit-card { background: var(--panel); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .card-header { padding: 8px 12px; background: #2a2a2a; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        /* Role Strips */
        .role-Leader { border-left: 4px solid #ba68c8; }
        .role-Troops { border-left: 4px solid #ffb74d; }
        .role-Support { border-left: 4px solid #4fc3f7; }
        .role-Specialist { border-left: 4px solid #e57373; }

        .role-badge { font-size: 0.65rem; padding: 2px 6px; background: #444; color: #ccc; border-radius: 3px; margin-right: 8px; text-transform: uppercase; }

        .card-body { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-col { grid-column: 1 / -1; }

        /* STATS GRID */
        .stats-container { display: flex; background: #222; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; }
        .stat-box { flex: 1; text-align: center; border-right: 1px solid var(--border); padding: 4px 0; }
        .stat-box:last-child { border: none; }
        .stat-lbl { font-size: 0.55rem; color: var(--text-muted); display: block; font-weight: bold; text-transform: uppercase; }
        .stat-val { font-size: 1rem; font-weight: bold; color: #fff; }

        /* CONFIGURATION */
        .section-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); margin-bottom: 8px; font-weight: bold; }
        
        .opt-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.85rem; }
        .opt-row select { width: 60%; margin: 0; padding: 2px; font-size: 0.8rem; }
        
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px; }
        .check-item { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
        .check-item:hover { border-color: #555; }
        .check-item input { width: auto; margin: 0 8px 0 0; }
        .cost-tag { margin-left: auto; color: var(--accent); font-size: 0.75rem; }

        .del-btn { background: transparent; border: none; color: #666; cursor: pointer; font-size: 1.2rem; }
        .del-btn:hover { color: var(--error); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="app-title">Tactics Terminal</div>

    <div class="control-group">
        <label class="control-label">Force Name</label>
        <input type="text" id="army-name" placeholder="e.g. 2nd Colonial Militia">
    </div>

    <div class="control-group">
        <label class="control-label">Add Unit</label>
        <select id="sel-role" onchange="updateUnitList()">
            <option value="" disabled selected>1. Select Role...</option>
            <option value="Leader">Leader (1-2)</option>
            <option value="Troops">Troops (2-4)</option>
            <option value="Support">Support (0-3)</option>
            <option value="Specialist">Specialist (1 per 2 Troops)</option>
        </select>
        <select id="sel-unit" disabled>
            <option>2. Select Unit...</option>
        </select>
        <button class="btn btn-primary" id="btn-add" onclick="addUnit()" disabled>+ Add to Platoon</button>
    </div>

    <div class="status-panel">
        <div class="status-row"><span>Total Points:</span> <span id="val-pts" class="status-val">0</span></div>
        <div class="status-row"><span>Leaders:</span> <span id="val-lead">0</span></div>
        <div class="status-row"><span>Troops:</span> <span id="val-troop">0</span></div>
        <div class="status-row"><span>Support:</span> <span id="val-supp">0</span></div>
        <div class="status-row"><span>Specialists:</span> <span id="val-spec">0</span></div>
        
        <div id="validation-msg" class="status-msg"></div>
    </div>

    <button class="btn btn-print" onclick="generatePDF()">üñ®Ô∏è Print Data Cards (PDF)</button>
</div>

<div class="main-content" id="roster">
    </div>

<script>
    // --- DATA REPOSITORY ---

    // Stats: [Speed, Reaction, Combat, Toughness, KP, Savvy, Training]
    // Veh Stats: [Speed, Toughness, KP, Capacity]
    
    const UNITS = {
        // --- LEADERS ---
        "Minor Character": { role: "Leader", type: "Infantry", models: 1, base: 15, stats: ['5"','4','+0','4','1','+0','+0'], wpn: "Hand Laser" },
        "Major Character": { role: "Leader", type: "Infantry", models: 1, base: 35, stats: ['6"','5','+1','4','2','+1','+1'], wpn: "Hand Laser" },

        // --- TROOPS ---
        "Infantry Squad": { role: "Troops", type: "Infantry", models: 5, base: 27, stats: ['4"','2','+0','3','1','+0','+0'], wpn: "Military Rifle", heavy:1 },
        "Recon Squad": { role: "Troops", type: "Infantry", models: 5, base: 23, stats: ['5"','3','+0','3','1','+1','+0'], wpn: "Military Rifle" },
        "Storm Squad": { role: "Troops", type: "Infantry", models: 5, base: 28, stats: ['4"','2','+1','4','1','+0','+1'], wpn: "Shotgun" },
        "Militia Squad": { role: "Troops", type: "Infantry", models: 5, base: 15, stats: ['4"','1','+0','3','1','+0','+0'], wpn: "Military Rifle", noSgt: true },
        "Enforcer Squad": { role: "Troops", type: "Infantry", models: 5, base: 15, stats: ['4"','2','+0','3','1','+0','+0'], wpn: "Shotgun" },
        "Pirate Squad": { role: "Troops", type: "Infantry", models: 5, base: 22, stats: ['4"','2','+1','3','1','+0','+0'], wpn: "Blaster" },
        "Cavalry Squad": { role: "Troops", type: "Infantry", models: 5, base: 25, stats: ['8"','2','+1','4','1','+0','+0'], wpn: "Military Rifle" },

        // --- SUPPORT (VEHICLES) ---
        "Nomad Bike": { role: "Support", type: "Vehicle", base: 15, vStats: ['12"', '6', '2', '0'], hardpoints: ["Forward Mount"] },
        "Scouter Bike": { role: "Support", type: "Vehicle", base: 35, vStats: ['16"', '5', '2', '0'], hardpoints: ["Forward Mount"] },
        "Lancer Bike": { role: "Support", type: "Vehicle", base: 30, vStats: ['12"', '5', '2', '0'], hardpoints: ["Forward Mount"] },
        "Frontier Trike": { role: "Support", type: "Vehicle", base: 35, vStats: ['10"', '6', '3', '0'], hardpoints: ["Forward", "Side Mount"] },
        "Raider Trike": { role: "Support", type: "Vehicle", base: 35, vStats: ['15"', '5', '3', '0'], hardpoints: ["Forward", "Side Mount"] },
        
        "Armored Car": { role: "Support", type: "Vehicle", base: 60, vStats: ['9"', '7', '5', '0'], hardpoints: ["Turret"] },
        "APC (Tracked)": { role: "Support", type: "Vehicle", base: 50, vStats: ['8"', '7', '5', '10'], hardpoints: ["Turret"] },
        "APC (Grav)": { role: "Support", type: "Vehicle", base: 55, vStats: ['9"', '7', '4', '8'], hardpoints: ["Turret"] },
        "IFV (Tracked)": { role: "Support", type: "Vehicle", base: 70, vStats: ['8"', '7', '5', '6'], hardpoints: ["Front", "Turret"] },
        
        "Light Tank": { role: "Support", type: "Vehicle", base: 100, vStats: ['8"', '8', '6', '0'], hardpoints: ["Front", "Coaxial", "Turret"] },
        "Medium Tank": { role: "Support", type: "Vehicle", base: 140, vStats: ['7"', '9', '7', '0'], hardpoints: ["Front", "Coaxial", "Turret"] },
        "Heavy Tank": { role: "Support", type: "Vehicle", base: 200, vStats: ['6"', '10', '8', '0'], hardpoints: ["Front", "Coaxial", "Turret"] },
        
        "Light Walker": { role: "Support", type: "Vehicle", base: 70, vStats: ['5"', '8', '4', '0'], hardpoints: ["Arm R", "Arm L"] },
        "Heavy Walker": { role: "Support", type: "Vehicle", base: 100, vStats: ['4"', '8', '5', '0'], hardpoints: ["Shoulder", "Arm R", "Arm L"] },
        
        // --- SUPPORT (TEAMS) ---
        "Weapon Team": { role: "Support", type: "Team", models: 3, base: 5, stats: ['4"','2','+0','3','1','+0','+0'], wpn: "Pistol", teamWpn: true },

        // --- SPECIALISTS ---
        "Tech": { role: "Specialist", type: "Specialist", models: 1, base: 5, stats: ['4"','2','+0','3','1','+0','+0'], wpn: "Pistol" },
        "Sharpshooter": { role: "Specialist", type: "Specialist", models: 1, base: 15, stats: ['4"','3','+0','3','1','+0','+0'], wpn: "Sniper Rifle" },
        "Medic": { role: "Specialist", type: "Specialist", models: 1, base: 10, stats: ['4"','2','+0','3','1','+0','+0'], wpn: "Pistol" },
        "Scout": { role: "Specialist", type: "Specialist", models: 1, base: 10, stats: ['5"','2','+0','3','1','+0','+0'], wpn: "Infantry Laser" },
        "Fire Section": { role: "Specialist", type: "Specialist", models: 2, base: 15, stats: ['4"','2','+0','3','1','+0','+0'], wpn: "Plasma Rifle", heavy: 1 }
    };

    const WEAPONS = {
        "Unarmed": 0, "Pistol": 0, "Blade": 0,
        "Hand Laser": 0, "Blast Pistol": 0, "Military Rifle": 3, "Shotgun": 2, "Blaster": 3, "Infantry Laser": 4, 
        "Sniper Rifle": 10, "Plasma Rifle": 8, "Fusion Rifle": 8, "Light MG": 10, "Heavy MG": 15, "Flamer": 8,
        "Grenade Launcher": 10, "Hyper Blaster": 6, "Fury Rifle": 7,
        "20mm Autocannon": 20, "40mm Autocannon": 25, "75mm Cannon": 45, "100mm Cannon": 55,
        "Laser Cannon": 35, "Pulse Laser": 35, "Anti-Tank Laser": 0, "Heavy Plasma": 20
    };

    const SQUAD_UPGRADES = {
        "Grenades (Frag)": 2, "Grenades (Fog)": 5, "Grenades (Penetrator)": 10,
        "Infantry Lasers (Swap)": 4, "Blasters (Swap)": 5, "Pistols (Add)": 5,
        "Breach Armor (x5)": 20, "Powered Armor (x5)": 10
    };

    const VET_SKILLS = {
        "None": 0, "Brave (+10)": 10, "Tank Hunters (+15)": 15, "Keen Shots (+10)": 10,
        "Die-hards (+5)": 5, "Fire Drill (+10)": 10, "Brawlers (+5)": 5, "Fearless (+5)": 5,
        "Gunnery (Veh) (+15)": 15, "Command (Veh) (+10)": 10, "Driving (Veh) (+10)": 10
    };

    const ATTACHMENTS = {
        "None": 0, "Tech (+5)": 5, "Medic (+10)": 10, "Comms (+10)": 10, "Scout (+10)": 10
    };

    let roster = [];

    // --- LOGIC ---

    function updateUnitList() {
        const role = document.getElementById('sel-role').value;
        const list = document.getElementById('sel-unit');
        list.innerHTML = `<option value="" disabled selected>2. Select Unit...</option>`;
        list.disabled = false;
        document.getElementById('btn-add').disabled = true;

        for (let name in UNITS) {
            if (UNITS[name].role === role) {
                list.innerHTML += `<option value="${name}">${name} (${UNITS[name].base} pts)</option>`;
            }
        }
    }

    document.getElementById('sel-unit').addEventListener('change', () => {
        document.getElementById('btn-add').disabled = false;
    });

    function addUnit() {
        const name = document.getElementById('sel-unit').value;
        const tmpl = UNITS[name];
        
        let unit = {
            id: Date.now(),
            name: name,
            template: name,
            role: tmpl.role,
            type: tmpl.type,
            
            // Config
            customName: "",
            mainWeapon: tmpl.wpn || "Unarmed",
            specialWeapon: "None",
            hardpoints: {},
            upgrades: [],
            veteran: "None",
            attachment: "None"
        };

        // Init Vehicle Hardpoints
        if (tmpl.type === "Vehicle" && tmpl.hardpoints) {
            tmpl.hardpoints.forEach(hp => unit.hardpoints[hp] = "None");
        }
        
        // Init Team Weapon
        if (tmpl.teamWpn) {
            unit.hardpoints["Main Gun"] = "Laser Cannon"; // Default
        }

        roster.push(unit);
        render();
    }

    function remove(id) {
        roster = roster.filter(u => u.id !== id);
        render();
    }

    function calcCost(u) {
        const tmpl = UNITS[u.template];
        let cost = tmpl.base;

        // Infantry Weapon Swaps (Standard logic: If upgrading entire squad)
        // Note: 5PFH Logic is simpler "Swap X for Y (+Points)". 
        // We will just add the cost of upgrades selected.
        
        u.upgrades.forEach(upg => cost += SQUAD_UPGRADES[upg]);
        
        // Special Weapons (Single model swaps)
        if (u.specialWeapon && u.specialWeapon !== "None") {
            cost += WEAPONS[u.specialWeapon];
        }

        // Vehicle / Team Weapons
        for (let hp in u.hardpoints) {
            let wpn = u.hardpoints[hp];
            if (wpn !== "None" && WEAPONS[wpn]) cost += WEAPONS[wpn];
        }

        // Skills & Attachments
        if (VET_SKILLS[u.veteran]) cost += VET_SKILLS[u.veteran];
        if (ATTACHMENTS[u.attachment]) cost += ATTACHMENTS[u.attachment];

        // Leader Upgrades (Manual logic: Hero +5)
        if (u.upgrades.includes("Hero (+5)")) cost += 5;
        if (u.upgrades.includes("Leader Ability (+10)")) cost += 10;

        return cost;
    }

    function render() {
        const container = document.getElementById('roster');
        container.innerHTML = "";
        
        let stats = { pts:0, lead:0, troop:0, supp:0, spec:0 };

        roster.forEach(u => {
            const tmpl = UNITS[u.template];
            const cost = calcCost(u);
            stats.pts += cost;
            if (u.role === "Leader") stats.lead++;
            if (u.role === "Troops") stats.troop++;
            if (u.role === "Support") stats.supp++;
            if (u.role === "Specialist") stats.spec++;

            const div = document.createElement('div');
            div.className = `unit-card role-${u.role}`;

            // --- HEADER ---
            let header = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; width:100%;">
                        <span class="role-badge">${u.role}</span>
                        <input type="text" value="${u.customName}" placeholder="${u.name}" 
                            style="background:transparent; border:none; font-weight:bold; color:white; margin:0; width:180px;"
                            onchange="update(this, ${u.id}, 'customName')">
                    </div>
                    <div style="font-weight:bold; color:#fff; white-space:nowrap;">${cost} PTS</div>
                    <button class="del-btn" onclick="remove(${u.id})" style="margin-left:10px;">&times;</button>
                </div>`;

            // --- STATS ---
            let statHTML = "";
            if (tmpl.type === "Vehicle") {
                statHTML = `
                <div class="stats-container">
                    <div class="stat-box"><span class="stat-lbl">SPD</span><span class="stat-val">${tmpl.vStats[0]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">TOU</span><span class="stat-val">${tmpl.vStats[1]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">KP</span><span class="stat-val">${tmpl.vStats[2]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">CAP</span><span class="stat-val">${tmpl.vStats[3]}</span></div>
                </div>`;
            } else {
                statHTML = `
                <div class="stats-container">
                    <div class="stat-box"><span class="stat-lbl">SPD</span><span class="stat-val">${tmpl.stats[0]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">REA</span><span class="stat-val">${tmpl.stats[1]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">COM</span><span class="stat-val">${tmpl.stats[2]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">TOU</span><span class="stat-val">${tmpl.stats[3]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">KP</span><span class="stat-val">${tmpl.stats[4]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">SAV</span><span class="stat-val">${tmpl.stats[5]}</span></div>
                    <div class="stat-box"><span class="stat-lbl">TRN</span><span class="stat-val">${tmpl.stats[6]}</span></div>
                </div>`;
            }

            // --- CONFIG ---
            let configHTML = "";
            
            // 1. Weapons (Hardpoints for Vehicles, Special for Inf)
            if (tmpl.type === "Vehicle") {
                for (let hp in u.hardpoints) {
                    configHTML += `
                    <div class="opt-row">
                        <span>${hp}</span>
                        <select onchange="update(this, ${u.id}, 'hp', '${hp}')">
                            <option value="None">Empty</option>
                            ${Object.keys(WEAPONS).filter(k => WEAPONS[k] > 0).map(w => 
                                `<option value="${w}" ${u.hardpoints[hp]===w?'selected':''}>${w} (+${WEAPONS[w]})</option>`).join('')}
                        </select>
                    </div>`;
                }
            } else if (tmpl.role === "Troops" && !tmpl.noSgt) {
                // Infantry Special Weapon Slot
                configHTML += `
                <div class="opt-row">
                    <span>Specialist Weapon</span>
                    <select onchange="update(this, ${u.id}, 'specWpn')">
                        <option value="None">None</option>
                        ${Object.keys(WEAPONS).filter(k => WEAPONS[k] > 5).map(w => 
                            `<option value="${w}" ${u.specialWeapon===w?'selected':''}>${w} (+${WEAPONS[w]})</option>`).join('')}
                    </select>
                </div>`;
            } else if (tmpl.teamWpn) {
                configHTML += `
                <div class="opt-row">
                    <span>Heavy Weapon</span>
                    <select onchange="update(this, ${u.id}, 'hp', 'Main Gun')">
                        <option value="Laser Cannon" ${u.hardpoints['Main Gun']==="Laser Cannon"?'selected':''}>Laser Cannon (35)</option>
                        <option value="20mm Autocannon" ${u.hardpoints['Main Gun']==="20mm Autocannon"?'selected':''}>20mm Autocannon (20)</option>
                        <option value="Infantry Mortar" ${u.hardpoints['Main Gun']==="Infantry Mortar"?'selected':''}>Infantry Mortar (15)</option>
                    </select>
                </div>`;
            }

            // 2. Upgrades (Checkbox Grid)
            let availUpgrades = [];
            if (u.role === "Leader") availUpgrades = ["Hero (+5)", "Leader Ability (+10)"];
            else if (u.role === "Troops") availUpgrades = Object.keys(SQUAD_UPGRADES);

            if (availUpgrades.length > 0) {
                configHTML += `<div class="section-title" style="margin-top:10px;">Squad Upgrades</div><div class="checkbox-grid">`;
                availUpgrades.forEach(upg => {
                    let cost = upg.match(/\d+/) ? "" : ""; // Cost is in name
                    let checked = u.upgrades.includes(upg) ? "checked" : "";
                    configHTML += `
                    <label class="check-item">
                        <input type="checkbox" ${checked} onchange="update(this, ${u.id}, 'upgrade', '${upg}')">
                        ${upg}
                    </label>`;
                });
                configHTML += `</div>`;
            }

            // 3. Vet & Attachments
            configHTML += `<div class="section-title" style="margin-top:10px;">Training & Support</div>`;
            
            configHTML += `
            <div class="opt-row">
                <span>Veteran Skill</span>
                <select onchange="update(this, ${u.id}, 'vet')">
                    ${Object.keys(VET_SKILLS).map(k => `<option ${u.veteran===k?'selected':''}>${k}</option>`).join('')}
                </select>
            </div>`;
            
            if (tmpl.type === "Infantry") {
                configHTML += `
                <div class="opt-row">
                    <span>Attachment</span>
                    <select onchange="update(this, ${u.id}, 'att')">
                        ${Object.keys(ATTACHMENTS).map(k => `<option ${u.attachment===k?'selected':''}>${k}</option>`).join('')}
                    </select>
                </div>`;
            }

            div.innerHTML = header + `<div class="card-body"><div class="full-col">${statHTML}</div><div class="full-col">${configHTML}</div></div>`;
            container.appendChild(div);
        });

        // UPDATE STATUS
        document.getElementById('val-pts').innerText = stats.pts;
        document.getElementById('val-lead').innerText = stats.lead;
        document.getElementById('val-troop').innerText = stats.troop;
        document.getElementById('val-supp').innerText = stats.supp;
        document.getElementById('val-spec').innerText = stats.spec;

        validate(stats);
    }

    function update(el, id, type, key) {
        let u = roster.find(x => x.id === id);
        if (!u) return;

        if (type === 'customName') u.customName = el.value;
        if (type === 'vet') u.veteran = el.value;
        if (type === 'att') u.attachment = el.value;
        if (type === 'specWpn') u.specialWeapon = el.value;
        if (type === 'hp') u.hardpoints[key] = el.value;
        if (type === 'upgrade') {
            if (el.checked) u.upgrades.push(key);
            else u.upgrades = u.upgrades.filter(x => x !== key);
        }
        render();
    }

    function validate(s) {
        let msg = [];
        if (s.lead < 1 || s.lead > 2) msg.push("‚Ä¢ Leaders: Must have 1-2.");
        if (s.troop < 2 || s.troop > 4) msg.push("‚Ä¢ Troops: Must have 2-4.");
        if (s.troop > 0 && s.supp >= s.troop) msg.push("‚Ä¢ Support: Must be fewer than Troops.");
        if (s.spec > Math.floor(s.troop / 2)) msg.push("‚Ä¢ Specialists: Max 1 per 2 Troops.");

        const box = document.getElementById('validation-msg');
        if (msg.length === 0) {
            box.innerHTML = "Platoon Structure Valid ‚úì";
            box.className = "status-msg valid-text";
        } else {
            box.innerHTML = msg.join("<br>");
            box.className = "status-msg error-text";
        }
    }

    // --- PDF GENERATION ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const armyName = document.getElementById('army-name').value || "TACTICAL PLATOON";

        // White background for printing
        doc.setFillColor(255, 255, 255); doc.rect(0, 0, 210, 297, 'F');
        
        // Header
        doc.setTextColor(0); doc.setFontSize(22); doc.setFont(undefined, 'bold');
        doc.text(armyName.toUpperCase(), 105, 20, null, null, 'center');
        doc.setFontSize(12); doc.setFont(undefined, 'normal');
        doc.text(`TOTAL POINTS: ${document.getElementById('val-pts').innerText}`, 105, 27, null, null, 'center');

        let y = 35;

        roster.forEach(u => {
            if (y > 240) { doc.addPage(); y = 20; }
            
            const tmpl = UNITS[u.template];
            const cost = calcCost(u);

            // Card Border (Rounded, Black)
            doc.setDrawColor(0); doc.setLineWidth(0.5);
            doc.roundedRect(20, y, 170, 50, 2, 2, 'S');

            // Header Strip (Grey)
            doc.setFillColor(220); 
            doc.roundedRect(20, y, 170, 10, 2, 2, 'F');
            doc.rect(20, y+8, 170, 2, 'F'); // Square off bottom corners of header

            // Name & Role
            doc.setFontSize(11); doc.setFont(undefined, 'bold');
            let dName = u.customName ? `${u.customName} (${u.name})` : u.name;
            doc.text(`${dName.toUpperCase()} [${u.role}]`, 25, y+7);
            doc.text(`${cost} PTS`, 185, y+7, null, null, 'right');

            // Stats Boxes
            doc.setFontSize(8); doc.setFont(undefined, 'normal');
            let x = 25;
            
            if (tmpl.type === "Vehicle") {
                // Vehicle Stats (4 boxes)
                const labels = ["SPD", "TOU", "KP", "CAP"];
                const vals = tmpl.vStats;
                labels.forEach((lbl, i) => {
                    doc.rect(x, y+13, 12, 12);
                    doc.setFontSize(6); doc.text(lbl, x+6, y+16, null, null, 'center');
                    doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text(vals[i], x+6, y+22, null, null, 'center');
                    x += 14;
                });
            } else {
                // Infantry Stats (7 boxes)
                const labels = ["SPD", "REA", "CBT", "TOU", "KP", "SAV", "TRN"];
                const vals = tmpl.stats;
                labels.forEach((lbl, i) => {
                    doc.rect(x, y+13, 12, 12);
                    doc.setFontSize(6); doc.text(lbl, x+6, y+16, null, null, 'center');
                    doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text(vals[i], x+6, y+22, null, null, 'center');
                    x += 14;
                });
            }

            // Info Text
            doc.setFontSize(9); doc.setFont(undefined, 'normal');
            let wpnTxt = "";
            if (tmpl.type === "Vehicle" || tmpl.teamWpn) {
                for (let hp in u.hardpoints) {
                    if (u.hardpoints[hp] !== "None") wpnTxt += `${hp}: ${u.hardpoints[hp]} | `;
                }
            } else {
                wpnTxt = `Main: ${tmpl.wpn}`;
                if (u.specialWeapon && u.specialWeapon !== "None") wpnTxt += ` | Spec: ${u.specialWeapon}`;
            }

            let gearTxt = u.upgrades.join(", ");
            let notes = [];
            if (u.veteran !== "None") notes.push(`Vet: ${u.veteran}`);
            if (u.attachment !== "None") notes.push(`Att: ${u.attachment}`);

            doc.text(`GEAR: ${wpnTxt}`, 25, y+32);
            if (gearTxt) doc.text(`UPGRADES: ${gearTxt}`, 25, y+38);
            if (notes.length) doc.text(`NOTES: ${notes.join(" | ")}`, 25, y+44);

            y += 55;
        });

        doc.save(armyName.replace(/ /g, "_") + ".pdf");
    }
</script>
</body>
</html>