<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactics Terminal - Definitive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --accent: #58a6ff; --delete: #f85149; --border: #30363d; --success: #238636; --leader: #f2e05d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .unit-card { background: #0d1117; padding: 20px; border-radius: 6px; margin-bottom: 25px; border-left: 5px solid var(--accent); border-top: 1px solid var(--border); position: relative; }
        
        .grid-header { display: grid; grid-template-columns: 2.5fr 1.5fr 140px; gap: 15px; margin-bottom: 20px; }
        
        .stats-row { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .stats-box { background: #161b22; padding: 8px; border-radius: 4px; border: 1px solid var(--border); flex: 1; min-width: 65px; text-align: center; }
        .stats-label { font-size: 0.65rem; color: var(--accent); font-weight: bold; margin-bottom: 4px; }
        .stats-box input { background: transparent; border: none; text-align: center; color: white; width: 100%; font-size: 1.1rem; font-weight: bold; }

        .wpn-section { background: #0d1117; border: 1px solid #333; padding: 12px; border-radius: 4px; margin: 15px 0; }
        .wpn-grid { display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 2fr; gap: 8px; align-items: center; }
        .wpn-header { font-size: 0.65rem; color: #8b949e; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .wpn-grid input { padding: 6px; font-size: 0.85rem; }

        .sub-panel { background: #21262d; padding: 15px; border-radius: 4px; margin: 10px 0; border: 1px solid #444; }
        .upgrade-tag { background: #30363d; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; margin: 4px; border: 1px solid var(--accent); }
        .tag-del { color: var(--delete); cursor: pointer; font-weight: bold; }

        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--accent); color: #000; width: 100%; font-size: 1.2rem; margin-top: 10px; }
        .hidden { display: none; }
        textarea { height: 60px; margin-top: 10px; resize: none; }
        .total-banner { font-size: 3.5rem; color: var(--accent); text-align: right; font-weight: bold; margin-top: 30px; border-top: 2px solid var(--border); padding-top: 15px; }
    </style>
</head>
<body>

<div style="text-align:center; padding-bottom:30px;">
    <h1 style="letter-spacing:6px; margin:0; color:white;">TACTICS TERMINAL v.FINAL</h1>
    <p style="color:var(--accent); font-weight:bold; letter-spacing:2px;">LOGISTICS & SQUAD MANAGEMENT</p>
</div>

<div class="container">
    <input type="text" id="force-name" placeholder="FORCE DESIGNATION..." style="font-size: 1.8rem; margin-bottom: 30px; text-align:center; border-color: var(--accent);" oninput="saveData()">
    <div id="unit-list"></div>
    <button class="btn btn-add" onclick="addUnit()">+ COMMISSION NEW ASSET</button>
    
    <div style="margin-top:40px; display:flex; gap:20px; justify-content:center;">
        <button class="btn" style="background:var(--success); color:white; padding: 18px 50px;" onclick="exportCards()">PRINT DATA CARDS (PDF)</button>
        <button class="btn" style="background:transparent; color:var(--delete); border:1px solid var(--delete);" onclick="clearAll()">RESET TERMINAL</button>
    </div>
    <div class="total-banner">TOTAL: <span id="total-pts">0</span> PTS</div>
</div>

<script>
    const UNIT_TYPES = {
        "Core Infantry": { pts: 20, spd: '4"', rea: '3', cbt: '4', tou: '4', kill: '1', sav: '5+', tra: 'Recruit' },
        "Elite": { pts: 40, spd: '5"', rea: '4', cbt: '3', tou: '4', kill: '1', sav: '4+', tra: 'Veteran' },
        "Vehicle": { pts: 0, spd: '0', tou: '0', kill: '0', cap: '0' }
    };

    const VEH_CHASSIS = {
        "Light": { cost: 30, tou: '5', kill: '2', cap: '2' },
        "Medium": { cost: 50, tou: '6', kill: '3', cap: '4' },
        "Heavy": { cost: 80, tou: '8', kill: '5', cap: '6' }
    };

    const VEH_PROP = { "Wheels": { cost: 0, spd: '10"' }, "Tracks": { cost: 5, spd: '8"' }, "Walker": { cost: 10, spd: '6"' }, "Grav": { cost: 20, spd: '12"' } };
    
    const UPGRADES = [
        { name: "Specialist Weapon", cost: 5 }, { name: "Heavy Weapon", cost: 10 },
        { name: "Jump Packs", cost: 8 }, { name: "Medical Kit", cost: 5 },
        { name: "Enhanced Armor", cost: 6 }, { name: "Camo Gear", cost: 5 },
        { name: "Targeting Computer (Veh)", cost: 12 }, { name: "Reinforced Hull (Veh)", cost: 15 }
    ];

    function addUnit(data = null) {
        const id = data?.id || Date.now() + Math.random();
        const unit = data || { id, name: '', type: 'Core Infantry', vChassis: 'Light', vProp: 'Wheels', spd:'4"', rea:'3', cbt:'4', tou:'4', kill:'1', sav:'5+', tra:'Recruit', cap: '0', upgrades: [], wpnName: '', wpnRng: '', wpnSho: '', wpnDmg: '', wpnTrt: '', desc: '' };
        renderUnit(unit);
    }

    function renderUnit(unit) {
        const list = document.getElementById('unit-list');
        const div = document.createElement('div');
        div.className = 'unit-card';
        div.dataset.id = unit.id;

        const isVeh = unit.type === 'Vehicle';

        div.innerHTML = `
            <div class="grid-header">
                <div><label class="wpn-header">Asset Name</label><input type="text" class="u-name" value="${unit.name}" oninput="saveData()"></div>
                <div><label class="wpn-header">Classification</label><select class="u-type" onchange="swapType(this)">
                    ${Object.keys(UNIT_TYPES).map(t => `<option value="${t}" ${unit.type===t?'selected':''}>${t}</option>`).join('')}
                </select></div>
                <div><label class="wpn-header">Logistics Pts</label><input type="text" class="u-pts" readonly style="color:var(--accent); font-weight:bold; font-size:1.3rem;"></div>
            </div>

            <div class="sub-panel v-cfg ${isVeh?'':'hidden'}">
                <div class="wpn-header" style="color:var(--accent)">Vehicle Spec</div>
                <div style="display:flex; gap:10px;">
                    <select class="v-chassis" onchange="saveData()">${Object.keys(VEH_CHASSIS).map(c=>`<option value="${c}" ${unit.vChassis===c?'selected':''}>${c} Chassis</option>`).join('')}</select>
                    <select class="v-prop" onchange="saveData()">${Object.keys(VEH_PROP).map(p=>`<option value="${p}" ${unit.vProp===p?'selected':''}>${p}</option>`).join('')}</select>
                </div>
            </div>

            <div class="stats-row">
                <div class="stats-box"><div class="stats-label">SPD</div><input type="text" class="u-spd" value="${unit.spd}" oninput="saveData()"></div>
                <div class="stats-box inf-only ${isVeh?'hidden':''}"><div class="stats-label">REA</div><input type="text" class="u-rea" value="${unit.rea}" oninput="saveData()"></div>
                <div class="stats-box inf-only ${isVeh?'hidden':''}"><div class="stats-label">CBT</div><input type="text" class="u-cbt" value="${unit.cbt}" oninput="saveData()"></div>
                <div class="stats-box"><div class="stats-label">TOU</div><input type="text" class="u-tou" value="${unit.tou}" oninput="saveData()"></div>
                <div class="stats-box"><div class="stats-label">KILL</div><input type="text" class="u-kill" value="${unit.kill}" oninput="saveData()"></div>
                <div class="stats-box inf-only ${isVeh?'hidden':''}"><div class="stats-label">SAV</div><input type="text" class="u-sav" value="${unit.sav}" oninput="saveData()"></div>
                <div class="stats-box inf-only ${isVeh?'hidden':''}"><div class="stats-label">TRA</div><input type="text" class="u-tra" value="${unit.tra}" oninput="saveData()"></div>
                <div class="stats-box veh-only ${isVeh?'':'hidden'}"><div class="stats-label">CAP</div><input type="text" class="u-cap" value="${unit.cap}" oninput="saveData()"></div>
            </div>

            <div class="wpn-section">
                <div class="wpn-grid">
                    <div class="wpn-header">Primary Weapon</div><div class="wpn-header">RNG</div><div class="wpn-header">SHO</div><div class="wpn-header">DMG</div><div class="wpn-header">TRAITS/ARC</div>
                    <input type="text" class="w-name" value="${unit.wpnName}" placeholder="e.g. Plasma Rifle" oninput="saveData()">
                    <input type="text" class="w-rng" value="${unit.wpnRng}" placeholder="18\"" oninput="saveData()">
                    <input type="text" class="w-sho" value="${unit.wpnSho}" placeholder="2" oninput="saveData()">
                    <input type="text" class="w-dmg" value="${unit.wpnDmg}" placeholder="1" oninput="saveData()">
                    <input type="text" class="w-trt" value="${unit.wpnTrt}" placeholder="Armor Piercing" oninput="saveData()">
                </div>
            </div>

            <div class="wpn-header">Upgrades</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select class="upg-drop">${UPGRADES.map((u,i)=>`<option value="${i}">${u.name} (+${u.cost})</option>`).join('')}</select>
                <button class="btn" style="background:#30363d; color:white;" onclick="addItem(this)">ADD</button>
            </div>
            <div class="u-tags" style="display:flex; flex-wrap:wrap;"></div>

            <textarea class="u-desc" placeholder="Special Traits & Secondary Weapons..." oninput="saveData()">${unit.desc}</textarea>
            
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="this.closest('.unit-card').remove(); saveData();" style="background:none; color:var(--delete); cursor:pointer;">[ DECOMMISSION ]</button>
                <button class="btn" style="background:var(--border); color:white;" onclick="cloneUnit(this)">CLONE ASSET</button>
            </div>
        `;
        list.appendChild(div);
        if(unit.upgrades) unit.upgrades.forEach(u => renderTag(div.querySelector('.u-tags'), u));
        updateTotal();
    }

    function swapType(select) {
        const card = select.closest('.unit-card');
        const type = select.value;
        const isVeh = type === 'Vehicle';
        card.querySelector('.v-cfg').classList.toggle('hidden', !isVeh);
        card.querySelectorAll('.inf-only').forEach(el => el.classList.toggle('hidden', isVeh));
        card.querySelectorAll('.veh-only').forEach(el => el.classList.toggle('hidden', !isVeh));
        if(!isVeh) {
            const tpl = UNIT_TYPES[type];
            ['spd','rea','cbt','tou','kill','sav','tra'].forEach(s => card.querySelector('.u-'+s).value = tpl[s]);
        }
        saveData();
    }

    function addItem(btn) {
        const card = btn.closest('.unit-card');
        const upg = UPGRADES[card.querySelector('.upg-drop').value];
        renderTag(card.querySelector('.u-tags'), upg);
        saveData();
    }

    function renderTag(container, item) {
        const span = document.createElement('span');
        span.className = 'upgrade-tag';
        span.dataset.name = item.name; span.dataset.cost = item.cost;
        span.innerHTML = `${item.name} (+${item.cost}) <span class="tag-del" onclick="this.parentElement.remove(); saveData();">Ã—</span>`;
        container.appendChild(span);
    }

    function cloneUnit(btn) {
        const card = btn.closest('.unit-card');
        const getTags = (selector) => Array.from(card.querySelectorAll(selector)).map(t => ({name: t.dataset.name, cost: t.dataset.cost}));
        const data = {
            id: Date.now() + Math.random(), name: card.querySelector('.u-name').value + " (Copy)", type: card.querySelector('.u-type').value,
            vChassis: card.querySelector('.v-chassis').value, vProp: card.querySelector('.v-prop').value,
            spd: card.querySelector('.u-spd').value, rea: card.querySelector('.u-rea').value, cbt: card.querySelector('.u-cbt').value,
            tou: card.querySelector('.u-tou').value, kill: card.querySelector('.u-kill').value, sav: card.querySelector('.u-sav').value,
            tra: card.querySelector('.u-tra').value, cap: card.querySelector('.u-cap').value,
            wpnName: card.querySelector('.w-name').value, wpnRng: card.querySelector('.w-rng').value, wpnSho: card.querySelector('.w-sho').value,
            wpnDmg: card.querySelector('.w-dmg').value, wpnTrt: card.querySelector('.w-trt').value,
            upgrades: getTags('.u-tags .upgrade-tag'), desc: card.querySelector('.u-desc').value
        };
        renderUnit(data);
        saveData();
    }

    function updateTotal() {
        let grand = 0;
        document.querySelectorAll('.unit-card').forEach(card => {
            const type = card.querySelector('.u-type').value;
            let pts = 0;
            if(type === 'Vehicle') {
                const c = VEH_CHASSIS[card.querySelector('.v-chassis').value];
                const p = VEH_PROP[card.querySelector('.v-prop').value];
                pts = c.cost + p.cost;
                card.querySelector('.u-spd').value = p.spd;
                card.querySelector('.u-tou').value = c.tou;
                card.querySelector('.u-kill').value = c.kill;
                card.querySelector('.u-cap').value = c.cap;
            } else {
                pts = UNIT_TYPES[type].pts;
            }
            card.querySelectorAll('.upgrade-tag').forEach(t => pts += parseInt(t.dataset.cost));
            card.querySelector('.u-pts').value = pts;
            grand += pts;
        });
        document.getElementById('total-pts').innerText = grand;
    }

    function saveData() {
        updateTotal();
        const units = [];
        document.querySelectorAll('.unit-card').forEach(card => {
            const getTags = (s) => Array.from(card.querySelectorAll(s)).map(t => ({name: t.dataset.name, cost: t.dataset.cost}));
            units.push({
                id: card.dataset.id, name: card.querySelector('.u-name').value, type: card.querySelector('.u-type').value,
                vChassis: card.querySelector('.v-chassis').value, vProp: card.querySelector('.v-prop').value,
                spd: card.querySelector('.u-spd').value, rea: card.querySelector('.u-rea').value, cbt: card.querySelector('.u-cbt').value,
                tou: card.querySelector('.u-tou').value, kill: card.querySelector('.u-kill').value, sav: card.querySelector('.u-sav').value,
                tra: card.querySelector('.u-tra').value, cap: card.querySelector('.u-cap').value,
                wpnName: card.querySelector('.w-name').value, wpnRng: card.querySelector('.w-rng').value, wpnSho: card.querySelector('.w-sho').value,
                wpnDmg: card.querySelector('.w-dmg').value, wpnTrt: card.querySelector('.w-trt').value,
                upgrades: getTags('.u-tags .upgrade-tag'), desc: card.querySelector('.u-desc').value
            });
        });
        localStorage.setItem('tactics_ultra_final', JSON.stringify({ name: document.getElementById('force-name').value, units }));
    }

    function exportCards() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let x = 10, y = 10;
        document.querySelectorAll('.unit-card').forEach(card => {
            const type = card.querySelector('.u-type').value;
            doc.setDrawColor(0).setLineWidth(0.5).rect(x, y, 90, 100);
            doc.setFillColor(22, 27, 34).rect(x, y, 90, 12, 'F');
            doc.setTextColor(255).setFontSize(13).setFont(undefined, 'bold').text(card.querySelector('.u-name').value || 'ASSET', x+3, y+8);
            
            doc.setTextColor(0).setFontSize(6);
            let stats = type === 'Vehicle' ? ['SPD','TOU','KILL','CAP'] : ['SPD','REA','CBT','TOU','KILL','SAV','TRA'];
            stats.forEach((s, i) => {
                doc.setFont(undefined, 'bold').text(s, x+3+(i*12.5), y+16);
                doc.setFont(undefined, 'normal').setFontSize(10).text(card.querySelector('.u-'+s.toLowerCase()).value, x+3+(i*12.5), y+21);
            });

            // Weapon Grid on PDF
            doc.setFillColor(240).rect(x, y+24, 90, 12, 'F');
            doc.setFontSize(6).setFont(undefined, 'bold').text("WEAPON", x+2, y+28);
            doc.text("RNG", x+30, y+28); doc.text("SHO", x+45, y+28); doc.text("DMG", x+60, y+28); doc.text("TRAITS", x+72, y+28);
            
            doc.setFontSize(8).setFont(undefined, 'normal');
            doc.text(card.querySelector('.w-name').value || '-', x+2, y+33);
            doc.text(card.querySelector('.w-rng').value || '-', x+30, y+33);
            doc.text(card.querySelector('.w-sho').value || '-', x+45, y+33);
            doc.text(card.querySelector('.w-dmg').value || '-', x+60, y+33);
            doc.text(doc.splitTextToSize(card.querySelector('.w-trt').value || '-', 18), x+72, y+33);

            doc.setFontSize(7).setFont(undefined, 'bold').text("SYSTEMS/UPGRADES:", x+3, y+45);
            let upgs = Array.from(card.querySelectorAll('.u-tags .upgrade-tag')).map(t => t.dataset.name).join(', ');
            doc.setFont(undefined, 'normal').text(doc.splitTextToSize(upgs || 'None', 84), x+3, y+49);
            
            doc.setFontSize(7).setFont(undefined, 'bold').text("OPERATIONAL NOTES:", x+3, y+62);
            doc.setFont(undefined, 'normal').text(doc.splitTextToSize(card.querySelector('.u-desc').value, 84), x+3, y+66);

            doc.setFontSize(14).setFont(undefined, 'bold').text(`${card.querySelector('.u-pts').value} PTS`, x+65, y+96);

            x += 95; if(x > 150) { x = 10; y += 105; }
            if(y > 200) { doc.addPage(); x = 10; y = 10; }
        });
        doc.save("Tactics_Final_Cards.pdf");
    }

    function clearAll() { if(confirm("ABORT: Clear all data?")) { localStorage.clear(); location.reload(); } }
    
    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('tactics_ultra_final'));
        if (saved) {
            document.getElementById('force-name').value = saved.name;
            saved.units.forEach(u => renderUnit(u));
        } else { addUnit(); }
    };
</script>
</body>
</html>